//     keymaster.js
//     (c) 2011-2012 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.
(function(e){function t(e,t){var n=e.length;while(n--)if(e[n]===t)return n;return-1}function n(e,n){var r,i,o,u,a;r=e.keyCode,t(w,r)==-1&&w.push(r);if(r==93||r==224)r=91;if(r in m){m[r]=!0;for(o in y)y[o]==r&&(s[o]=!0);return}if(!s.filter.call(this,e))return;if(!(r in v))return;for(u=0;u<v[r].length;u++){i=v[r][u];if(i.scope==n||i.scope=="all"){a=i.mods.length>0;for(o in m)if(!m[o]&&t(i.mods,+o)>-1||m[o]&&t(i.mods,+o)==-1)a=!1;(i.mods.length==0&&!m[16]&&!m[18]&&!m[17]&&!m[91]||a)&&i.method(e,i)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}}function r(e){var n=e.keyCode,r,i=t(w,n);i>=0&&w.splice(i,1);if(n==93||n==224)n=91;if(n in m){m[n]=!1;for(r in y)y[r]==n&&(s[r]=!1)}}function i(){for(d in m)m[d]=!1;for(d in y)s[d]=!1}function s(e,t,n){var r,i,s,o;n===undefined&&(n=t,t="all"),e=e.replace(/\s/g,""),r=e.split(","),r[r.length-1]==""&&(r[r.length-2]+=",");for(s=0;s<r.length;s++){i=[],e=r[s].split("+");if(e.length>1){i=e.slice(0,e.length-1);for(o=0;o<i.length;o++)i[o]=y[i[o]];e=[e[e.length-1]]}e=e[0],e=b[e]||e.toUpperCase().charCodeAt(0),e in v||(v[e]=[]),v[e].push({shortcut:r[s],scope:t,method:n,key:r[s],mods:i})}}function o(e){if(typeof e=="string"){if(e.length!=1)return!1;e=e.toUpperCase().charCodeAt(0)}return t(w,e)!=-1}function u(){return w}function a(e){var t=(e.target||e.srcElement).tagName;return t!="INPUT"&&t!="SELECT"&&t!="TEXTAREA"}function f(e){g=e||"all"}function l(){return g||"all"}function c(e){var t,n,r;for(t in v){n=v[t];for(r=0;r<n.length;)n[r].scope===e?n.splice(r,1):r++}}function h(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}function p(){var t=e.key;return e.key=E,t}var d,v={},m={16:!1,18:!1,17:!1,91:!1},g="all",y={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},b={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},w=[];for(d=1;d<20;d++)y["f"+d]=111+d;for(d in y)s[d]=!1;h(document,"keydown",function(e){n(e,g)}),h(document,"keyup",r),h(window,"focus",i);var E=e.key;e.key=s,e.key.setScope=f,e.key.getScope=l,e.key.deleteScope=c,e.key.filter=a,e.key.isPressed=o,e.key.getPressedKeyCodes=u,e.key.noConflict=p,typeof module!="undefined"&&(module.exports=key)})(this),function(){var e;window.KeyLauncher||(window.KeyLauncher={}),(e=window.KeyLauncher).loaders||(e.loaders={}),window.loadedScripts={},window.scriptTimers={},KeyLauncher.loaders.stylesheet=function(e,t,n){var r;return t==null&&(t={}),r=document.createElement("link"),r.type="text/css",r.rel="stylesheet",r.href=e,document.getElementsByTagName("head")[0].appendChild(r),n.call(this)},KeyLauncher.loaders.script=function(e,t,n){var r,i,s,o,u,a;t==null&&(t={}),i=loadedScripts,a=scriptTimers,typeof t=="function"&&n==null&&(n=t,t={}),r=document.getElementsByTagName("head")[0],o=document.createElement("script"),o.src=e,o.type="text/javascript",u=this,s=function(){typeof n=="function"&&n.call(u,e,t,o);try{r.removeChild(o)}catch(s){!0}return i[e]=!0};if(t.once===!0&&i[e])return!1;r.appendChild(o),o.onreadystatechange=function(){if(o.readyState==="loaded"||o.readyState==="complete")return s()},o.onload=s;if(typeof navigator!="undefined"&&navigator!==null?navigator.userAgent.match(/WebKit/):void 0)return a[e]=setInterval(function(){return s(),clearInterval(a[e])},10)}}.call(this),function(){window.KeyLauncher.Launcher=function(){function Launcher(e){var t,n,r;this.options=e!=null?e:{},this.fn=e.fn,this.before=e.before,this.command=e.command,r=this.options.requires;for(t in r)n=r[t],this._dependencies[n]={loaded:!1,provides:t}}return Launcher.prototype._dependencies={},Launcher.prototype.run=function(){var state,type,url,_ref,_ref1,_results,_this=this;this.ran=!1,(_ref=this.before)!=null&&typeof _ref.call=="function"&&_ref.call(this);if(this.isReady())return this.onReady();_ref1=this._dependencies,_results=[];for(url in _ref1){state=_ref1[url];try{state.loaded=eval(state.provides)!=null}catch(e){state.loaded=!1}state.loaded!==!0?(type=url.match(/\.css/)?"stylesheet":"script",_results.push(KeyLauncher.loaders[type](url,function(e){return _this.onDependencyLoad(e)}))):_results.push(void 0)}return _results},Launcher.prototype.requires=function(e){return this._dependencies[e]={loaded:!1}},Launcher.prototype.isReady=function(){var e,t,n,r;t=!0,r=this._dependencies;for(e in r)n=r[e],n.loaded===!1&&(t=!1);return t},Launcher.prototype.onDependencyLoad=function(e){this._dependencies[e].loaded=!0;if(this.isReady())return this.onReady()},Launcher.prototype.onReady=function(){var e=this;if(!this.isReady()||this.ran!==!1)return;return function(){return e.fn.call(e),e.ran=!0}()},Launcher}()}.call(this),function(){var e;KeyLauncher.VERSION="0.0.4",KeyLauncher.on=function(e,t,n){var r;n==null&&(n={});if(e==null)throw"Must specify a valid key command";return r=new KeyLauncher.Launcher({command:e,fn:t||function(){},before:n.before,requires:n.requires||[]}),key(e,function(){return r.run.call(r)}),r},e=function(e,t){var n,r,i,s,o;s=KeyLauncher.currentSequence||"",o=t.shortcut,KeyLauncher.currentSequence=""+s+o,i=function(){var e,t;e=KeyLauncher.sequences,t=[];for(n in e)r=e[n],n.match(KeyLauncher.currentSequence)&&t.push(n);return t}(),i.length>0||(KeyLauncher.currentSequence="");if(i.length===1&&(r=KeyLauncher.sequences[KeyLauncher.currentSequence]))return r.run.call(r),KeyLauncher.currentSequence=""},KeyLauncher.onSequence=function(t,n,r){var i,s,o,u,f;r==null&&(r={}),KeyLauncher.sequences||(KeyLauncher.sequences={}),s=KeyLauncher.sequences[t]=new KeyLauncher.Launcher({fn:n||function(){},requires:r.requires||[],before:r.before}),f=t.split("");for(o=0,u=f.length;o<u;o++)i=f[o],key(i,e);return s}}.call(this),function(){var e,t,n,r=[].slice;t=this,typeof exports!="undefined"?e=exports:e=t.CodeSync={},e.VERSION="0.6.6",e.backends={},e.util={},e.plugins={},e._config||(e._config={defaultFileType:"coffeescript",assetCompilationEndpoint:"http://localhost:9295/source",serverInfoEndpoint:"http://localhost:9295/info",sprocketsEndpoint:"http://localhost:9295/assets",socketEndpoint:"http://localhost:9295/faye",editorToggleHotkey:"ctrl+j",debugMode:!1}),e.set=function(t,n){return e._config[t]=n},e.get=function(t){return e._config[t]},e.enableLogging=function(){return e.set("debugMode",!0)},e.log=function(){var t;t=1<=arguments.length?r.call(arguments,0):[];if(e.get("debugMode")!==!1)return t.unshift("CodeSync Log:"),console.log.apply(console,t)},n=CodeMirror.prototype.setOption}.call(this),function(){var sourceEval;CodeSync.Client=function(){function e(e){var t=this;e==null&&(e={}),this.logLevel=e.logLevel||0,CodeSync.Client._clients.push(this),CodeSync.util.loadScript(""+CodeSync.get("socketEndpoint")+"/client.js",function(){if(t.clientLoaded===!0)return;return setTimeout(function(){try{return t.setupSocket()}catch(e){return console.log("Error setting up codesync client")}},25),t.clientLoaded=!0})}return e._clients=[],e.get=function(){return CodeSync.Client._clients[0]},e.prototype.VERSION=CodeSync.VERSION,e.prototype.logLevel=0,e.prototype.subscribeWith=function(e){var t;return(t=this.socket)!=null?t.subscribe("/code-sync/outbound",e):void 0},e.prototype.setupSocket=function(){var e=this;if(typeof Faye=="undefined"||Faye===null)return;return this.socket=new Faye.Client(CodeSync.get("socketEndpoint")),this.subscribeWith(function(t){var n,r,i;e.logLevel>0&&console.log("Received notification on outbound channel",t),(n=e.onNotification)!=null&&typeof n.call=="function"&&n.call(e,t),((r=t.name)!=null?r.match(/\.js$/):void 0)&&e.onJavascriptNotification.call(e,t);if((i=t.name)!=null?i.match(/\.css$/):void 0)return e.onStylesheetNotification.call(e,t)})},e.prototype.javascriptCallbacks=[],e.prototype.stylesheetCallbacks=[],e.prototype.removeJavascriptCallbacks=function(){return this.javascriptCallbacks=[]},e.prototype.removeStylesheetCallbacks=function(){return this.stylesheetCalbacks=[]},e.prototype.afterJavascriptChange=function(e,t){return t==null&&(t=!1),this.javascriptCallbacks||(this.javascriptCallbacks=[]),t===!0&&(this.javascriptCallbacks=[]),this.javascriptCallbacks.push(e)},e.prototype.afterStylesheetChange=function(e,t){return t==null&&(t=!1),this.stylesheetCallbacks||(this.stylesheetCallbacks=[]),t===!0&&(this.stylesheetCallbacks=[]),this.stylesheetCallbacks.push(e)},e.prototype.onJavascriptNotification=function(e){var t,n,r,i,s;n=this,CodeSync.processing=!0;if(e.source){sourceEval.call(window,e.source),s=n.javascriptCallbacks;for(r=0,i=s.length;r<i;r++)t=s[r],t.call!=null&&t.call(n,e);CodeSync.processing=!1;return}if(e.path)return console.log("notification",e.path),CodeSync.util.loadScript(""+CodeSync.get("sprocketsEndpoint")+"/"+e.path,function(){var r,i,s,o;s=n.javascriptCallbacks,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],t.call!=null&&o.push(t.call(this,e));return o})},e.prototype.onStylesheetNotification=function(e){var t;t=this;if(e.path&&e.name)return CodeSync.util.loadStylesheet(""+CodeSync.get("sprocketsEndpoint")+"/"+e.path,{tracker:e.name},function(){var n,r,i,s,o;s=t.stylesheetCallbacks,o=[];for(r=0,i=s.length;r<i;r++)n=s[r],n.call!=null&&o.push(n.call(this,e));return o})},e}(),sourceEval=function(source){return eval(source)}}.call(this),function(){var e,t;CodeSync.util||(CodeSync.util={}),e={},t={},CodeSync.util.loadStylesheet=function(e,t,n){var r;return t==null&&(t={}),r=document.createElement("link"),r.type="text/css",r.rel="stylesheet",r.href=e,r.className="code-sync-asset",t.tracker&&($("link[data-tracker='"+t.tracker+"']").remove(),r.setAttribute("data-tracker",t.tracker)),document.getElementsByTagName("head")[0].appendChild(r),n!=null?typeof n.call=="function"?n.call(this):void 0:void 0},CodeSync.util.loadScript=function(n,r,i){var s,o,u,a,f,l;r==null&&(r={}),o=e,l=t,typeof r=="function"&&i==null&&(i=r,r={}),s=document.getElementsByTagName("head")[0],a=document.createElement("script"),a.src=n,a.type="text/javascript",f=this,u=function(){typeof i=="function"&&i.call(f,n,r,a);try{s.removeChild(a)}catch(e){!0}return o[n]=!0};if(r.once===!0&&o[n])return!1;s.appendChild(a),a.onreadystatechange=function(){if(a.readyState==="loaded"||a.readyState==="complete")return u()},a.onload=u;if(typeof navigator!="undefined"&&navigator!==null?navigator.userAgent.match(/WebKit/):void 0)return l[n]=setInterval(function(){return u(),clearInterval(l[n])},10)}}.call(this),function(){this.Skim={access:function(e){var t;return t=this[e],typeof t=="function"&&(t=t.call(this)),t===!0?[this]:t===!1||t==null?!1:Object.prototype.toString.call(t)!=="[object Array]"?[t]:t.length===0?!1:t},withContext:function(e,t){var n;return n=function(e){var t;return t=function(){},t.prototype=e,new t},e=n(e),e.safe||(e.safe=this.safe||function(e){var t;return(e!=null?e.skimSafe:void 0)?e:(t=new String(e!=null?e:""),t.skimSafe=!0,t)}),e.escape||(e.escape=this.escape||function(e){return e==null?"":e.skimSafe?e:this.safe((""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\//g,"&#47;"))}),t.call(e)}}}.call(this),function(){this.JST||(this.JST={}),this.JST["code_sync/editor/templates/asset_editor"]=function(){return function(e){return e==null&&(e={}),Skim.withContext.call({},e,function(){var e;return e=[],e.push('<div class="toolbar-wrapper"></div><div class="codesync-asset-editor"></div>'),e.join("")})}}.call(this)}.call(this),function(){this.JST||(this.JST={}),this.JST["code_sync/editor/templates/asset_selector"]=function(){return function(e){return e==null&&(e={}),Skim.withContext.call({},e,function(){var e;return e=[],e.push('<div class="asset-selector-wrapper"><div class="search-input"><input placeholder="Type the name of an asset to open it" type="text" /></div><div class="search-results-wrapper"><div class="search-results"></div></div></div>'),e.join("")})}}.call(this)}.call(this),function(){this.JST||(this.JST={}),this.JST["code_sync/editor/templates/document_manager_tab"]=function(){return function(e){return e==null&&(e={}),Skim.withContext.call({},e,function(){var e,t,n,r,i,s,o,u;return n=[],t=this.display||this.doc.get("display")||this.doc.get("name"),e=["document-tab"],this.cls!=null&&e.push(this.cls),this.doc!=null&&e.push("selectable"),this.closable&&((r=this.doc)!=null?!r.isSticky():!void 0)&&e.push("closable"),this.index!==0&&e.push("hideable"),this.doc!=null&&((i=this.doc)!=null?!i.isSticky():!void 0)&&e.push("editable"),n.push("<div"),o=[],o.push(this.escape(e.join(" "))),o.join(""),o.length>0&&(n.push(' class="'),n.push(o),n.push('"')),u=[],u.push(this.escape((s=this.doc)!=null?s.cid:void 0)),u.join(""),u.length>0&&(n.push(' data-document-cid="'),n.push(u),n.push('"')),n.push('><span class="contents">'),n.push(this.escape(t)),n.push('</span><small class="close-anchor">x</small></div>'),n.join("")})}}.call(this)}.call(this),function(){this.JST||(this.JST={}),this.JST["code_sync/editor/templates/element_sync"]=function(){return function(e){return e==null&&(e={}),Skim.withContext.call({},e,function(){var e;return e=[],e.push('<div class="element-sync-panel"><div class="row"><div class="span9"><input name="css-selector" placeholder="Enter a CSS selector to sync with" /></div><div class="span3"><select name="action"><option value="html">Replace</option><option value="before">Before</option><option value="before">After</option></select></div></div><div class="row"><div class="span9"><div class="element-sync-status"></div><input class="done-button" type="button" value="Done" /><input class="hide-panel-button" type="button" value="Hide" /></div></div></div>'),e.join("")})}}.call(this)}.call(this),function(){this.JST||(this.JST={}),this.JST["code_sync/editor/templates/preferences_panel"]=function(){return function(e){return e==null&&(e={}),Skim.withContext.call({},e,function(){var e,t,n;return e=[],e.push('<form><div class="control-group"><label>KeyBindings</label><div class="controls"><select name="keyMap"><option value="default">Default</option><option value="vim">Vim</option></select></div></div><div class="control-group"><label>Theme</label><div class="controls"><select name="theme"><option value="ambiance">Ambiance</option><option value="lesser-dark">Lesser Dark</option><option value="monokai">Monokai</option><option value="xq-light">XQ Light</option></select></div></div><div class="control-group"><label>Asset Compiler Endpoint</label><div class="controls"><input name="asset_endpoint" type="text"'),t=[],t.push(this.escape(CodeSync.get("assetCompilationEndpoint"))),t.join(""),t.length>0&&(e.push(' value="'),e.push(t),e.push('"')),e.push(' /></div></div><div class="control-group"><label>Hotkey</label><div class="controls"><input name="editor_hotkey" type="text"'),n=[],n.push(this.escape(CodeSync.get("editorToggleHotkey"))),n.join(""),n.length>0&&(e.push(' value="'),e.push(n),e.push('"')),e.push(' /></div></div><div class="control-group"><label>Position</label><div class="controls"><select name="position"><option value="top">Top</option><option value="bottom">Bottom</option></select></div></div></form>'),e.join("")})}}.call(this)}.call(this),function(){var helpers,__slice=[].slice;CodeSync.Document=Backbone.Model.extend({callbackDelay:150,initialize:function(e,t){var n,r,i=this;this.attributes=e;if(n=this.attributes.localStorageKey)(r=this.attributes).contents||(r.contents=localStorage.getItem(n));return Backbone.Model.prototype.initialize.apply(this,arguments),_.bindAll(this,"onContentChange"),this.on("change:contents",this.onContentChange),this.on("change:name",function(){return i.set("mode",i.determineMode()),i.set("display",i.nameWithoutExtension())}),this.on("change:mode",function(){return i.set("extension",i.determineExtension(),{silent:!0})})},url:function(){return CodeSync.get("assetCompilationEndpoint")},saveToDisk:function(){if(this.isSaveable())return this.sendToServer(!0,"saveToDisk")},saveToLocalStorage:function(e){if(e!=null)return localStorage.setItem(e,this.get("contents"))},loadSourceFromDisk:function(e){var t=this;return $.ajax({url:""+this.url()+"?path="+this.get("path"),type:"GET",success:function(n){n==null&&(n={});if(n.success===!0&&n.contents!=null)return t.set("contents",n.contents,{silent:!0}),e(t)}})},toJSON:function(){return{name:this.nameWithoutExtension(),path:this.get("path"),extension:this.get("extension")||this.determineExtension(),contents:this.toContent()}},nameWithoutExtension:function(){var e;return e=this.get("extension")||this.determineExtension(),(this.get("name")||"untitled").replace(e,"")},toMode:function(){var e,t;return e=this.get("mode")||this.determineMode(),t=CodeSync.Modes.getMode(e)},toCodeMirrorMode:function(){var e;return(e=this.toMode())!=null?e.get("codeMirrorMode"):void 0},toCodeMirrorDocument:function(){return CodeMirror.Doc(this.toContent(),this.toCodeMirrorMode(),0)},toCodeMirrorOptions:function(){return this.toMode().get("codeMirrorOptions")},toContent:function(){var e;return""+(this.get("contents")||((e=this.toMode())!=null?e.get("defaultContent"):void 0)||" ")},onContentChange:function(){var e;return e=this.get("localStorageKey"),e=e!=null&&_.isFunction(e)?e.call(this):e,localStorage.setItem(e,this.get("contents")),this.sendToServer(!1,"onContentChange")},sendToServer:function(e,t){var n,r=this;return e==null&&(e=!1),t==null&&(t=""),this.isSaveable()||(e=!1),n=e===!0?this.toJSON():_(this.toJSON()).pick("name","extension","contents"),CodeSync.log("Sending Data To "+CodeSync.get("assetCompilationEndpoint"),n),$.ajax({type:"POST",url:CodeSync.get("assetCompilationEndpoint"),data:JSON.stringify(n),error:function(e){return CodeSync.log("Document Process Error",arguments)},success:function(e){var n,i;CodeSync.log("Document Process Response",e),e.success===!0&&r.trigger("status",{type:"success",message:r.successMessage(t),compiled:e.compiled}),e.success===!0&&e.compiled!=null&&r.set("compiled",e.compiled);if(e.success===!1&&e.error!=null)return r.set("error",(n=e.error)!=null?n.message:void 0),r.trigger("status",{type:"error",message:(i=e.error)!=null?i.message:void 0})}})},loadInPage:function(e){e==null&&(e={});if(this.type()==="stylesheet")return helpers.processStyleContent.call(this,this.get("compiled"));if(this.type()==="script"||this.type()==="template"){helpers.processScriptContent.call(this,this.get("compiled"));if(e.complete)return _.delay(e.complete,e.delay||this.callbackDelay)}},type:function(){switch(this.get("mode")){case"css":case"sass":case"scss":case"less":return"stylesheet";case"coffeescript":case"javascript":return"script";case"skim":case"mustache":case"jst":case"haml":case"eco":return"template"}},missingFileName:function(){var e;return e=this.get("path")||this.get("name"),e==null||e.length===0},determineExtension:function(){var e,t;t=this.get("path")||this.get("name");if(e=CodeSync.Document.getExtensionFor(t))return e;if(this.get("mode")!=null)return CodeSync.Modes.guessExtensionFor(this.get("mode")||CodeSync.get("defaultFileType"))},determineMode:function(){var e;return e=this.get("path")||this.get("name")||this.get("extension"),CodeSync.Modes.guessModeFor(e)},successMessage:function(e){if(this.type()==="template")return'Success.  Template will be available as JST["'+this.nameWithoutExtension()+'"]'},isSticky:function(){return this.get("sticky")!=null==1},isSaveable:function(){var e;return((e=this.get("path"))!=null?e.length:void 0)>0&&!this.get("doNotSave")}}),CodeSync.Document.getFileNameFrom=function(e){return e==null&&(e=""),e.split("/").pop()},CodeSync.Document.getExtensionFor=function(e){var t,n,r,i,s;e==null&&(e=""),t=CodeSync.Document.getFileNameFrom(e),s=t.split("."),n=s[0],r=2<=s.length?__slice.call(s,1):[];if(i=r.length>0&&r.join("."))return"."+i},CodeSync.Documents=Backbone.Collection.extend({model:CodeSync.Document,initialize:function(e,t){var n;Backbone.Collection.prototype.initialize.apply(this,arguments);if(n=CodeSync.Client.get()&&(n!=null?n.socket:void 0)!=null)return n.subscribeWith(function(e){return console.log("Documents",e)})},nextId:function(){return this.models.length+1},findByPath:function(e){var t;return t=this.detect(function(t){var n;return(n=t.get("path"))!=null?n.match(e):void 0})},findOrCreateForPath:function(e,t){var n,r,i,s,o,u=this;return e==null&&(e=""),(r=this.findByPath(e))?typeof t=="function"?t(r):void 0:(o=CodeSync.Document.getFileNameFrom(e),i=CodeSync.Document.getExtensionFor(o),n=o.replace(i,""),s=this.nextId(),r=new CodeSync.Document({name:o,extension:i,display:n,path:e,id:s}),r.loadSourceFromDisk(function(){return typeof t=="function"?t(r):void 0}))}}),helpers={processStyleContent:function(e){return $("head style[data-codesync-document]").remove(),$("head").append("<style type='text/css' data-codesync-document=true>"+e+"</style>")},processScriptContent:function(code){var doc,evalRunner;return doc=this,evalRunner=function(code){try{return eval(code)}catch(e){throw doc.trigger("status",{type:"error",message:"JS Error: "+e.message,sticky:!0}),e}},evalRunner.call(window,code)}}}.call(this),function(){CodeSync.Gist=Backbone.Model.extend({initialize:function(e){this.attributes=e!=null?e:{}},url:function(){},toDocuments:function(){}})}.call(this),function(){var e;CodeSync.Modes=Backbone.Collection.extend({model:Backbone.Model.extend({isTemplate:function(){return this.get("template")===!0}}),initialize:function(t,n){var r,i,s;return t==null&&(t=[]),n==null&&(n={}),t=function(){var t,n;n=[];for(i in e)s=e[i],n.push(r={id:i,name:s.name||i,codeMirrorMode:s.codeMirrorMode||i,extension:s.extension,extensionRegex:new RegExp(""+s.extension),template:s.template===!0||i==="skim"||((t=s.extension)!=null?t.match(/jst/):void 0),defaultContent:s.defaultContent});return n}(),Backbone.Collection.prototype.initialize.apply(this,arguments),this.reset(t,{silent:!0})},findModeFor:function(e){var t,n=this;return e==null&&(e=""),e.match(/\./)||(e="."+e),t=this.detect(function(t){var n;return n=t.get("extensionRegex"),n.exec(e)}),t!=null?t.get("codeMirrorMode"):void 0},findExtensionFor:function(e){return e=this.detect(function(t){return t.get("codeMirrorMode")===e||t.get("id")===e}),e!=null?e.get("extension"):void 0},defaultMode:function(){return this.get(CodeSync.get("defaultFileType"))||this.first()}}),CodeSync.Modes.getMode=function(e){return CodeSync.Modes.get().get(e)},CodeSync.Modes.guessModeFor=function(e){return CodeSync.Modes.get().findModeFor(e)},CodeSync.Modes.guessExtensionFor=function(e){return CodeSync.Modes.get().findExtensionFor(e)},CodeSync.Modes.get=function(){var e;return(e=CodeSync.Modes).singleton||(e.singleton=new CodeSync.Modes)},CodeSync.Modes.defaultMode=function(){return CodeSync.Modes.get().defaultMode()},e={coffeescript:{extension:".coffee",codeMirrorOptions:{indentUnit:2,smartIndent:!0,tabSize:2,indentWithTabs:!1},defaultContent:'# You are currently in Coffeescript Mode\n#\n# Any coffeescript you type in here will be evaluated.\n#\n# defining this function will allow you to respond\n# to code and template changes that happen in this editor.\n#\n#\n# CodeSync.onScriptChange = (changeObject)->\n#   console.log "Detected new code from CodeSync", changeObject\n#\n#'},sass:{name:"Sass",extension:".css.sass",defaultContent:"// You are currently in Sass mode.",codeMirrorOptions:{indentUnit:2,smartIndent:!0,tabSize:2,indentWithTabs:!1}},scss:{codeMirrorMode:"css",extension:".css.scss",name:"SCSS",defaultContent:"/* You are currently in SCSS mode. */"},skim:{extension:".jst.skim",defaultContent:"// You are currently in Skim mode.\n// The contents of this template will be available on the JST object.",template:!0,codeMirrorOptions:{indentUnit:2,smartIndent:!0,tabSize:2,indentWithTabs:!1}},css:{name:"CSS",extension:".css",defaultContent:"/* You are currently in raw CSS mode. */"},javascript:{name:"Javascript",extension:".js",defaultContent:"/* You are currently in raw JS mode. */"}}}.call(this),function(){CodeSync.ProjectAssets=Backbone.Collection.extend({url:function(){return CodeSync.get("serverInfoEndpoint")},parse:function(e){var t,n,r;return n=function(){var n,i,s,o;s=_.uniq(e.project_assets),o=[];for(n=0,i=s.length;n<i;n++)r=s[n],t=r.replace(e.root,""),o.push({path:r,description:t});return o}(),n},initialize:function(){return this.fetch(),Backbone.Collection.prototype.initialize.apply(this,arguments)}})}.call(this),function(){CodeSync.AssetSelector=Backbone.View.extend({className:"codesync-asset-selector",events:{"keyup input":"keyHandler","click .search-result":"selectSearchResult"},initialize:function(e){var t=this;return e==null&&(e={}),Backbone.View.prototype.initialize.apply(this,arguments),this.editor=e.editor,_.bindAll(this,"keyHandler","loadAsset"),this.selected=new Backbone.Model({index:-1}),this.selected.on("change:index",function(e,n){return t.$(".search-result").removeClass("active"),t.$(".search-result").eq(n).addClass("active")})},keyHandler:function(e){switch(e.keyCode){case 13:return this.openCurrentSearchResult();case 27:return this.hide();case 38:return this.previousSearchResult();case 40:return this.nextSearchResult();default:return this.filterAssetsBy(this.$("input").val())}},openCurrentSearchResult:function(){var e,t,n=this;t=this.selected.attributes.index;if(e=this.searchResults[t])return this.selected.set("index",0,{silent:!0}),_.delay(function(){return n.loadAsset(n.searchResults[t].get("path"))},10),this.hide()},previousSearchResult:function(){var e;return e=this.selected.attributes.index,e-=1,e<0&&(e=0),this.selected.set({index:e})},nextSearchResult:function(){var e;return e=this.selected.attributes.index,e+=1,e>this.searchResults.length&&(e=0),this.selected.set({index:e})},selectSearchResult:function(e){var t;return this.loadAsset((t=$(e.target))!=null?t.data("path"):void 0)},loadAsset:function(e){return this.trigger("asset:selected",e)},filterAssetsBy:function(e){var t,n,r,i,s,o;if(e.length<=1)return;r=this.showSearchResults(),r.empty(),this.selected.set("index",-1,{silent:!0}),this.searchResults=this.collection.select(function(t){var n,r,i;return n=new RegExp(""+e),((r=t.get("description"))!=null?r.match(n):void 0)||((i=t.get("path"))!=null?i.match(n):void 0)}),this.searchResults=this.searchResults.slice(0,5),o=this.searchResults;for(t=i=0,s=o.length;i<s;t=++i)n=o[t],r.append("<div data-path='"+n.get("path")+"' class='search-result'>"+n.get("description")+"</div>");return r.height(this.searchResults.length*40)},showSearchResults:function(){return this.wrapper.show()},hideSearchResults:function(){return this.wrapper.hide()},toggle:function(){return this.visible?this.hide():this.show()},show:function(){return this.wrapper.empty(),this.visible=!0,this.$el.show(),this.hideSearchResults(),this.$("input").val("").focus()},hide:function(){return this.$el.hide(),this.visible=!1,this.editor.codeMirror.focus()},render:function(){return this.$el.html(JST["code_sync/editor/templates/asset_selector"]()),this.wrapper||(this.wrapper=this.$(".search-results-wrapper")),this}})}.call(this),function(){CodeSync.plugins.ColorPicker=Backbone.View.extend({className:"codesync-color-picker",widget:!1,spectrumOptions:{showAlpha:!1,preferredFormat:"hex6",flat:!0,showInput:!0,chooseText:"Choose"},initialize:function(e){return this.options=e!=null?e:{},_.extend(this,this.options),this.$el.append("<input type='color' class='color-picker-widget' />"),this.widget=this.$(".color-picker-widget")},remove:function(){return this.widget.spectrum("destroy"),this.$el.remove()},hide:function(){return this.widget.spectrum("hide"),this.$el.hide(),this.off("color:change")},show:function(){return this.widget.spectrum("show"),this.widget||this.$el.addClass("anchored"),this.$el.show()},syncWithToken:function(e,t){var n,r,i,s,o=this;return n=this.editor.codeMirror,this.widget===!0&&(this.$el.removeClass("anchored"),n.addWidget(t,this.el)),this.show(),i=n.getLine(t.line),s=e.start,r=e.end,this.widget.spectrum("set",e.string),this.on("color:change",_.debounce(function(e,i){return n.replaceRange("#"+i,{line:t.line,ch:s},{line:t.line,ch:r})},1200))},render:function(){var e,t=this;return e=_.extend(this.spectrumOptions,{move:_.debounce(function(e){return t.trigger("color:change",e,e.toHex())},200)}),this.widget.spectrum(this.spectrumOptions),this}}),CodeSync.plugins.ColorPicker.setup=function(e){var t;return this.colorPicker=new CodeSync.plugins.ColorPicker({editor:e}),this.$el.append(e.colorPicker.render().el),this.colorPicker.hide(),t=e.codeMirror,t.on("cursorActivity",function(){var n,r,i,s;return n=t.getCursor(),r=t.getTokenAt(n),((i=r.string)!=null?i.match(/#[a-fA-F0-9]{3,6}/g):void 0)&&((s=r.string)!=null?s.length:void 0)>=6?e.colorPicker.syncWithToken(r,n):e.colorPicker.hide()})}}.call(this),function(){CodeSync.DocumentManager=Backbone.Model.extend({initialize:function(e){var t,n,r,i;this.attributes=e!=null?e:{},this.editor=this.attributes.editor,delete this.attributes.editor,this.openDocuments=new CodeSync.Documents,i=["add","remove","change:display","change:sticky"];for(n=0,r=i.length;n<r;n++)t=i[n],this.openDocuments.on(t,this.notify,this);return Backbone.Model.prototype.initialize.apply(this,arguments)},getEditor:function(){return this.editor||_(CodeSync.AssetEditor.instances).values()[0]},detect:function(e){return this.openDocuments.each(e)},each:function(e){return this.openDocuments.each(e)},notify:function(){return this.trigger("document:change")},openDocument:function(e,t){return t||(t=this.getEditor()),this.openDocuments.add(e),this.setCurrentDocument(e,t)},setCurrentDocument:function(e,t){return this.currentDocument=e,t||(t=this.editor),t.loadDocument(this.currentDocument)},saveDocument:function(){return CodeSync.get("disableAssetSave")?this.getEditor().showError("Saving is disabled."):this.currentDocument.saveToDisk()},createDocument:function(e){var t,n,r,i;return e||(e=this.getEditor()),r=((i=e.mode)!=null?i.id:void 0)||CodeSync.get("defaultFileType"),n=CodeSync.Modes.guessExtensionFor(r),t=new CodeSync.Document({name:"untitled",display:"Untitled",mode:r,extension:n}),this.openDocument(t,e)}})}.call(this),function(){CodeSync.plugins.DocumentTabs=Backbone.View.extend({includeActionTabs:!0,allowNew:!0,allowOpen:!0,allowSave:CodeSync.get("allowSaving")===!0,events:{"click .selectable":"onDocumentTabSelection","click .closable .close-anchor":"closeTab","click .new-document":"createDocument","click .save-document":"saveDocument","click .open-document":"toggleAssetSelector","dblclick .editable":"onDoubleClickTab","blur .editable .contents":"onEditableTabBlur","keydown .editable .contents":"onEditableTabKeyPress"},tabTemplate:JST["code_sync/editor/templates/document_manager_tab"],views:{},initialize:function(e){var t=this;return this.options=e!=null?e:{},_.extend(this,e),this.editor=e.editor,this.manager=this.editor.documentManager,this.docs=this.manager.openDocuments,this.manager.on("document:change",this.renderTabs,this),this.projectAssets=new CodeSync.ProjectAssets,this.on("editor:hidden",function(){return t.$(".document-tab.hideable").hide()}),this.on("editor:visible",function(){return t.$(".document-tab.hideable").show()}),this.views.assetSelector=new CodeSync.AssetSelector({collection:this.projectAssets,documents:this.docs,editor:this.editor}),this.views.assetSelector.on("asset:selected",this.onAssetSelection,this),Backbone.View.prototype.initialize.apply(this,arguments)},tabsContainer:function(){var e;return e=this.$(".document-tabs-container")},documentInTab:function(e){var t,n;e.is(".document-tab")||(e=e.parents(".document-tab").eq(0));if(t=e.data("document-cid"))return n=this.docs.detect(function(e){return e.cid===t})},renderTabs:function(){var e,t,n=this;e=this.tabsContainer().empty(),t=this.tabTemplate,this.docs.each(function(r,i){if(n.skipTabForDefault!==!0||i!==0)return e.append(t({doc:r,index:i,closable:i>0}))});if(this.includeActionTabs){this.allowOpen&&this.addOpenDocumentTab();if(this.allowNew)return this.addNewDocumentTab()}},addOpenDocumentTab:function(){return this.tabsContainer().append(this.tabTemplate({display:"Open",cls:"open-document"}))},addNewDocumentTab:function(){return this.tabsContainer().append(this.tabTemplate({display:"New",cls:"new-document"}))},addSaveDocumentTab:function(){return this.tabsContainer().append(this.tabTemplate({display:"Save",cls:"save-document"}))},onAssetSelection:function(e){var t=this;return this.docs.findOrCreateForPath(e,function(e){return t.manager.openDocument(e,t.editor)})},onEditableTabKeyPress:function(e){var t,n,r,i;i=this.$(e.target).closest(".document-tab"),t=i.children(".contents"),console.log("On Editable Tab Keypress"
,e.keyCode,e.which);if(e.keyCode===13||e.keyCode===27){e.preventDefault(),t.attr("contenteditable",!1);if(n=this.documentInTab(i))e.keyCode===13&&n.set("name",t.html()),e.keyCode===27&&(r=i.attr("data-original-value"))&&t.html(r);return this.restoreFocus()}},restoreFocus:function(){return this.editor.codeMirror.focus()},onEditableTabBlur:function(e){var t,n,r;console.log("On Editable Tab Blur"),r=this.$(e.target).closest(".document-tab"),t=r.children(".contents");if(n=this.documentInTab(r))return n.set("name",t.html()),t.attr("contenteditable",!1)},onDoubleClickTab:function(e){var t,n;return console.log("On Double Click Tab"),n=this.$(e.target).closest(".document-tab"),t=n.children(".contents"),n.attr("data-original-value",t.html()),t.attr("contenteditable",!0)},onDocumentTabSelection:function(e){var t,n;return this.trigger("tab:click"),n=this.$(e.target).closest(".document-tab"),t=this.documentInTab(n),this.manager.setCurrentDocument(t,this.editor)},closeTab:function(e){var t,n,r;return r=this.$(e.target),t=this.documentInTab(r),n=this.docs.indexOf(t),this.docs.remove(t),this.manager.setCurrentDocument(this.docs.at(n-1)||this.docs.at(0),this.editor)},createDocument:function(){return this.manager.createDocument()},toggleAssetSelector:function(){return this.views.assetSelector.toggle()},render:function(){return this.$el.append("<div class='document-tabs-container' />"),this.$el.append(this.views.assetSelector.render().el),this}}),CodeSync.plugins.DocumentTabs.setup=function(e,t){var n,r=this;return t==null&&(t={}),t.editor=e,n=this.views.documentTabs=new CodeSync.plugins.DocumentTabs(t),this.$el.append(n.render().el),n.on("tab:click",function(){if(r.visible===!1)return r.show()})}}.call(this),function(){CodeSync.plugins.ElementSync=Backbone.View.extend({className:"codesync-element-sync toggleable-input",action:"html",events:{"keyup input":function(){return this.bindToSelector()},"change select":function(e){return this.action=this.$(e.target).val()},"click .hide-panel-button":function(){return this.hide()},"click .done-button":function(){return this.clear()}},initialize:function(e){var t=this;return this.options=e!=null?e:{},_.extend(this,this.options),this.bindToSelector=_.debounce(function(){return t.selector=t.getValue(),t.$elementSync=$(t.selector),t.status()},500),this.editor.on("code:sync:template",this.syncWithElement,this),this.editor.on("change:mode",function(e){return e.isTemplate()?t.toggleButton(!0):(t.hide(),t.toggleButton(!1))}),this.visible=!1,this.$el.hide(),this.toggleButton(!1)},syncWithElement:function(e,t){var n,r;return this.selector&&((r=this.$elementSync)!=null?typeof r[n=this.action||"html"]=="function"?r[n](t()):void 0:void 0)},getSelectorContents:function(){return this.$(this.selector).html()},getValue:function(){return this.$('input[name="css-selector"]').val()},clear:function(){return this.$('input[name="css-selector"]').val(""),this.$elementSync=void 0,this.selector="",this.$(".element-sync-status").html("")},existsInDocument:function(){var e;return((e=this.$elementSync)!=null?e.length:void 0)>0},status:function(){var e,t,n;return e=(n=this.$elementSync)!=null?n.length:void 0,t=e===0&&this.getValue().length>0?"CSS Selector not found":e===1?"1 total element":e>0?""+e+" total elements":"",this.$(".element-sync-status").html(t)},render:function(){return this.$el.html(JST["code_sync/editor/templates/element_sync"]()),this.status(),this},show:function(){return this.visible=!0,this.$el.show()},hide:function(){return this.visible=!1,this.$el.hide()},toggle:function(){return this.visible?this.hide():this.show()},toggleButton:function(e){return e==null&&(e=!0),e?this.editor.$(".toggle-element-sync").show():this.editor.$(".toggle-element-sync").hide()}}),CodeSync.plugins.ElementSync.setup=function(e){var t,n=this;return this.$(".toolbar-wrapper").append("<div class='button toggle-element-sync'>Sync w/ Element</div>"),t=new CodeSync.plugins.ElementSync({editor:e}),e.views.elementSync=t,this.events["click .toggle-element-sync"]=function(){return t.toggle()},this.$el.append(t.render().el)}}.call(this),function(){CodeSync.plugins.KeymapSelector=Backbone.View.extend({className:"config-select keymap-selector",events:{"change select":"onSelect"},initialize:function(e){var t=this;return e==null&&(e={}),this.editor=e.editor,this.editor.on("change:keymap",function(e){return t.setValue(e)}),Backbone.View.prototype.initialize.apply(this,arguments)},onSelect:function(){var e;return e=this.$("select").val(),this.editor.setKeyMap(e)},setValue:function(e){return this.$("select").val(e)},hideLabel:function(){return this.$("label").hide()},showLabel:function(){return this.$("label").show()},render:function(){var e,t,n,r,i;t="",i=["default","vim"];for(n=0,r=i.length;n<r;n++)e=i[n],t+="<option value='"+e+"'>"+e+"</option>";return this.$el.html("<label>Keymap</label> <select>"+t+"</select>"),this.visibleLabel||this.hideLabel(),this}}),CodeSync.plugins.KeymapSelector.setup=function(e){var t;return t=this.views.keymapSelector=new CodeSync.plugins.KeymapSelector({editor:e}),this.$(".toolbar-wrapper").append(t.render().el)}}.call(this),function(){CodeSync.plugins.ModeSelector=Backbone.View.extend({className:"config-select mode-selector",events:{"change select":"onSelect"},initialize:function(e){var t=this;return e==null&&(e={}),this.editor=e.editor,this.modes=this.editor.modes,this.modes.on("reset",this.render,this),this.editor.on("change:mode",function(e,n){return t.setValue(n)}),Backbone.View.prototype.initialize.apply(this,arguments)},onSelect:function(){var e,t;return t=this.$("select").val(),e=this.modes.get(t),this.editor.setMode(e)},setValue:function(e){return this.$("select").val(e)},hideLabel:function(){return this.$("label").hide()},showLabel:function(){return this.$("label").show()},render:function(){var e,t,n,r,i;t="",i=this.modes.models;for(n=0,r=i.length;n<r;n++)e=i[n],t+="<option value='"+e.id+"'>"+e.get("name")+"</option>";return this.$el.html("<label>Language:</label> <select>"+t+"</select>"),this.visibleLabel||this.hideLabel(),this}}),CodeSync.plugins.ModeSelector.setup=function(e){var t;return t=this.views.modeSelector=new CodeSync.plugins.ModeSelector({editor:e}),this.$(".toolbar-wrapper").append(t.render().el),e.on("document:loaded",function(e){return t.setValue(e.get("mode"))})}}.call(this),function(){CodeSync.NameInput=Backbone.View.extend({className:"asset-name-input",events:{"change input":"updateEditor","keyup input":"updateEditor","blur input":"toggle"},initialize:function(e){return e==null&&(e={}),this.editor=e.editor,_.bindAll(this,"_updateEditor","updateEditor","toggle"),this._updateEditor=_.debounce(CodeSync.NameInput.prototype._updateEditor,300),Backbone.View.prototype.initialize.apply(this,arguments)},render:function(){return this.$el.append("<input type='text' placeholder='Enter the name of the asset' />"),this.$el.hide(),this},updateEditor:function(){return this._updateEditor()},_updateEditor:function(){var e,t;e=this.$("input").val();if(e.match(/\./))return this.editor.currentName=e,t=this.editor.determineModeFor(e)},setValue:function(e){return this.$("input").val(e)},getValue:function(){return this.$("input").val()},toggle:function(){var e;return((e=this.getValue())!=null?e.length:void 0)===0&&(this.editor.setDefaultExtension(),this.editor.currentName=this.editor.currentPath=void 0),this.$el.toggle()}})}.call(this),function(){CodeSync.plugins.PreferencesPanel=Backbone.View.extend({className:"preferences-panel",events:{"change select,input":function(){return this.trigger("update:preferences")}},renderHidden:!0,initialize:function(e){return this.editor=e.editor,this.$el.html(JST["code_sync/editor/templates/preferences_panel"]()),Backbone.View.prototype.initialize.apply(this,arguments)},values:function(){var e,t,n,r,i,s;n={},s=this.$("input,select");for(r=0,i=s.length;r<i;r++)e=s[r],t=$(e),n[t.attr("name")]=t.val();return n},toggle:function(){return this.syncWithEditorOptions(),this.$el.toggle()},syncWithEditorOptions:function(){return this.$('select[name="theme"]').val(this.editor.codeMirror.getOption("theme")),this.$('select[name="keyMap"]').val(this.editor.codeMirror.getOption("keyMap")),this.$('input[name="asset_endpoint"]').val(CodeSync.get("assetCompilationEndpoint")),this.$('input[name="editor_hotkey"]').val(CodeSync.get("editorToggleHotKey"))},render:function(){return this.renderHidden===!0&&this.$el.hide(),this}}),CodeSync.plugins.PreferencesPanel.setup=function(e){var t,n=this;return t=new CodeSync.plugins.PreferencesPanel({editor:this}),this.$(".toolbar-wrapper").append("<div class='button toggle-preferences'>Preferences</div>"),this.events["click .toggle-preferences"]=function(){return t.toggle()},this.$el.append(t.render().el),t.on("update:preferences",function(){var n;return n=t.values(),e.setTheme(n.theme),e.setKeyMap(n.keyMap),CodeSync.set("assetCompilationEndpoint",n.asset_endpoint),CodeSync.AssetEditor.setHotKey(n.editor_hotkey)}),e.on("codemirror:setup",function(e){return e.on("focus",function(){return t.$el.hide()})}),t.on("update:preferences",function(){var n;n=t.values();if(e.position!==n.position)return e.setPosition(n.position)})}}.call(this),function(){CodeSync.AssetEditor=Backbone.View.extend({name:"code_sync",className:"codesync-editor",position:"top",enableToolbar:!0,enableStatusMessages:!0,autoRender:!0,autoAppend:!0,appendTo:"body",renderVisible:!0,effect:"slide",effectDuration:400,editorChangeThrottle:800,visible:!1,showVisibleTab:!0,hideable:!0,startMode:"scss",theme:"ambiance",keyBindings:"",events:{"click .status-message":"removeStatusMessages","click .hide-button":"hide"},plugins:["DocumentTabs","ModeSelector","PreferencesPanel","ElementSync","KeymapSelector"],pluginOptions:{},views:{},initialize:function(e){var t=this;this.options=e!=null?e:{},_.extend(this,this.options),Backbone.View.prototype.initialize.apply(this,arguments),console.log("Creatin Instance",this.name,this.cid,this),CodeSync.AssetEditor.instances[this.name||this.cid]=this,_.bindAll(this,"editorChangeHandler"),this.modes=CodeSync.Modes.get(),this.documentManager=new CodeSync.DocumentManager({editor:this}),this.startMode=this.modes.get(this.startMode)||CodeSync.Modes.defaultMode(),this.on("editor:change",_.debounce(this.editorChangeHandler,this.editorChangeThrottle),this),this.on("codemirror:setup",function(){return t.loadDefaultDocument()}),this.$el.html(JST["code_sync/editor/templates/asset_editor"]()),this.name!=null&&this.$el.attr("data-codesync",this.name),this.loadPlugins(),this.setPosition(this.position,!1);if(this.autoRender!==!1)return this.render()},addPlugin:function(e){var t;return(t=CodeSync.plugins[e])!=null?t.setup.call(this,this):void 0},loadPlugins:function(){var e,t,n,r,i,s,o;s=this.plugins,o=[];for(r=0,i=s.length;r<i;r++){n=s[r];if(CodeSync.plugins[n]==null)continue;t=this.pluginOptions[n]||{},e=CodeSync.plugins[n],o.push(e.setup.call(this,this,t))}return o},render:function(){var e=this;return this.rendered===!0?this:(this.setupToolbar(),this.delegateEvents(),this.rendered=!0,this.autoAppend===!0&&$(this.appendTo).prepend(this.el),this.renderHidden===!0&&(this.show(),setTimeout(function(){return e.hide()},900)),this.renderVisible===!0&&this.show(),this)},setupCodeMirror:function(){var e,t=this;if(this.codeMirror!=null)return;return this.height||(this.height=this.$el.height()),this.codeMirror=CodeMirror(this.$(".codesync-asset-editor")[0],this.getCodeMirrorOptions()),this.on("initial:document:load",function(){t.startMode&&t.setMode(t.startMode),t.keyBindings&&t.setKeyMap(t.keyBindings);if(t.theme||(t.theme=localStorage.getItem("codesync:theme")))return t.setTheme(t.theme)}),e=function(e){return t.trigger("editor:change",t.codeMirror.getValue(),e)},this.codeMirror.on("change",_.debounce(e,this.editorChangeThrottle)),this.trigger("codemirror:setup",this.codeMirror),this},codeMirrorKeyBindings:{"Ctrl+Command+1":function(){var e;return(e=CodeSync.get("commandOne"))!=null?typeof e.call=="function"?e.call(this):void 0:void 0},"Ctrl+Command+2":function(){var e;return(e=CodeSync.get("commandTwo"))!=null?typeof e.call=="function"?e.call(this):void 0:void 0},"Ctrl+Command+3":function(){var e;return(e=CodeSync.get("commandThree"))!=null?e.call(this):void 0}},getCodeMirrorOptions:function(){var e,t,n,r,i,s;r={},i=this.codeMirrorKeyBindings;for(t in i)e=i[t],r[t]=!1,key(t,_.bind(e,this));return n={theme:"lesser-dark",lineNumbers:!0,mode:((s=this.startMode)!=null?s.get("codeMirrorMode"):void 0)||CodeSync.get("defaultFileType"),extraKeys:r}},editorChangeHandler:function(e){return this.currentDocument.set("contents",e)},setPosition:function(e,t){var n,r,i,s;this.position=e!=null?e:"top",t==null&&(t=!0),s=["top","bottom","static"];for(r=0,i=s.length;r<i;r++)n=s[r],n!==this.position&&this.$el.removeClass(""+n+"-positioned");return this.$el.addClass(""+this.position+"-positioned"),this.$el.removeAttr("style"),t===!0&&this.show(),this},setKeyMap:function(e){var t;return this.keyMap!=null&&e!==this.keyMap&&(this.trigger("change:keyMap",e,this.keyMap),(t=this.onKeyMapChange)!=null&&t.call(this,e,this.keyMap)),this.codeMirror.setOption("keyMap",this.keyMap=e)},setTheme:function(e){var t;return this.theme!=null&&e!==this.theme&&(this.trigger("change:theme",e,this.theme),(t=this.onThemeChange)!=null&&t.call(this,e,this.theme)),this.$el.attr("data-codesync-theme",this.theme=e),this.codeMirror.setOption("theme",this.theme=e)},setMode:function(e){var t,n;return this.mode!=null&&e!==this.mode&&(this.trigger("change:mode",e,e.id),(t=this.onModeChange)!=null&&t.call(this,e,this.mode)),this.mode=e,this.$el.attr("data-codesync-mode",this.mode.id),((n=this.mode)!=null?n.get:void 0)!=null&&(this.codeMirror.setOption("mode",this.mode.get("codeMirrorMode")),this.currentDocument.set("mode",this.mode.id),this.currentDocument.set("extension",CodeSync.Modes.guessExtensionFor(this.mode.id))),this},setCodeMirrorOptions:function(e){var t,n,r;e==null&&(e={}),r=[];for(t in e)n=e[t],r.push(this.codeMirror.setOption(t,n));return r},setupToolbar:function(){this.enableToolbar||this.$(".toolbar-wrapper").hide();if(this.hideable===!0)return this.$(".toolbar-wrapper").append("<div class='button hide-button'>Hide</div>")},getDefaultDocument:function(){var e,t,n;return t={mode:this.options.startMode||CodeSync.get("defaultFileType"),sticky:!0,doNotSave:!0,name:this.defaultDocumentName||"codesync",display:"CodeSync"},n=_.extend(t,this.document),e=new CodeSync.Document(n)},loadDefaultDocument:function(){return this.documentManager.openDocument(this.getDefaultDocument(),this)},loadDocument:function(e){var t;return(t=this.currentDocument)?(t.off("status",this.showStatusMessage),t.off("change:compiled",this.applyDocumentContentToPage),t.off("change:mode",this.applyDocumentContentToPage,this),this.previousDocument=t):this.trigger("initial:document:load",this.currentDocument=e),e.on("status",this.showStatusMessage,this),e.on("change:compiled",this.applyDocumentContentToPage,this),e.on("change:mode",this.syncEditorModeWithDocument,this),this.codeMirror.swapDoc(e.toCodeMirrorDocument()),this.trigger("document:loaded",e,this.previousDocument),this.setCodeMirrorOptions(e.toCodeMirrorOptions()),this.currentDocument=e},syncEditorModeWithDocument:function(){if(this.currentDocument!=null&&this.currentDocument.toMode()!==this.mode)return this.setMode(this.currentDocument.toMode())},applyDocumentContentToPage:function(){var e,t=this;return(e=this.currentDocument)!=null?e.loadInPage({complete:function(){var e,n;return(t.currentDocument.type()==="script"||t.currentDocument.type()==="template")&&(e=CodeSync.onScriptChange)!=null&&e.call(window,t.currentDocument.attributes),t.currentDocument.type()==="stylesheet"&&(n=CodeSync.onStylesheetChange)!=null&&n.call(window,t.currentDocument.attributes),t.trigger("code:sync",t.currentDocument),t.trigger("code:sync:"+t.currentDocument.type(),t.currentDocument,typeof JST!="undefined"&&JST!==null?JST[t.currentDocument.nameWithoutExtension()]:void 0)}}):void 0},removeStatusMessages:function(){return this.$(".status-message").remove()},showError:function(e){return this.showStatusMessage({type:"error",message:e})},showStatusMessage:function(e){var t,n,r=this;e==null&&(e={}),this.removeStatusMessages(),t=function(){switch(this.enableStatusMessages){case!1:return[];case!0:case"all":return["success","error","notice"];default:return[this.enableStatusMessages]}}.call(this);if(!(_(t).indexOf(e.type)>=0))return;((n=e.message)!=null?n.length:void 0)>0&&this.$el.prepend("<div class='status-message "+e.type+"'>"+e.message+"</div>");if(e.type==="success")return _.delay(function(){return r.$(".status-message.success").animate({opacity:0},{duration:400,complete:function(){return r.$(".status-message.success").remove()}})},1200)},hintHeight:function(){var e;return e=this.showVisibleTab?this.$(".document-tabs-container").height():0},visibleStyleSettings:function(){var e;return this.position==="static"&&(e={}),this.position==="top"&&(e={top:"0px"}),this.position==="bottom"&&(e={bottom:"0px",height:"400px"}),e},hiddenStyleSettings:function(){var e;return this.position==="static"&&(e={}),this.position==="top"&&(e={top:(this.$el.height()+8)*-1+this.hintHeight(),bottom:"auto"}),this.position==="bottom"&&(e={bottom:"0px",height:""+(this.hintHeight()-8)+"px"}),e},hide:function(e){var t,n,r,i,s=this;e==null&&(e=!0),console.trace(),this.animating=!0,i=this.views;for(r in i)n=i[r],n.trigger("editor:hidden");return this.hideable&&this.$el.removeAttr("data-visible"),t=_.debounce(function(){return s.visible=!1,s.animating=!1},this.effectDuration+20),e!==!1?(this.$el.animate(this.hiddenStyleSettings(),{duration:this.effectDuration,complete:t}),_.delay(t,this.effectDuration)):t(),this},show:function(e){var t,n,r,i,s=this;e==null&&(e=!0),this.setupCodeMirror(),this.animating=!0,i=this.views;for(r in i)n=i[r],n.trigger("editor:visible");return this.hideable&&this.$el.attr("data-visible",!0),t=_.debounce(function(){return s.visible=!0,s.animating=!1},this.effectDuration),e!==!1?(this.$el.removeAttr("style").css("top","").css("bottom",""),this.$el.animate(this.visibleStyleSettings(),{duration:this.effectDuration,complete:t}),_.delay(t,this.effectDuration)):t(),this},toggle:function(){if(this.animating===!0)return;return this.visible===!0?this.hide(!0):this.show(!0)}}),CodeSync.AssetEditor.instances={},CodeSync.commands={commandOne:function(){},commandTwo:function(){},commandThree:function(){}},CodeSync.AssetEditor.keyboardShortcutInfo="ctrl+j: toggle editor ctrl+t: open asset",CodeSync.AssetEditor.toggleEditor=_.debounce(function(e){return e==null&&(e={}),window.codeSyncEditor!=null?window.codeSyncEditor.toggle():(window.codeSyncEditor=new CodeSync.AssetEditor(e),$("body").prepend(window.codeSyncEditor.render().el),window.codeSyncEditor.show())},1),CodeSync.AssetEditor.setHotKey=function(e,t){return t==null&&(t={}),CodeSync.set("editorToggleHotkey",e),key(e,function(){return CodeSync.AssetEditor.toggleEditor(t)})}}.call(this),function(){}.call(this),function(){}.call(this);