/**
 * Supported keybindings:
 *
 *   Motion:
 *   h, j, k, l
 *   gj, gk
 *   e, E, w, W, b, B, ge, gE
 *   f<character>, F<character>, t<character>, T<character>
 *   $, ^, 0, -, +, _
 *   gg, G
 *   %
 *   '<character>, `<character>
 *
 *   Operator:
 *   d, y, c
 *   dd, yy, cc
 *   g~, g~g~
 *   >, <, >>, <<
 *
 *   Operator-Motion:
 *   x, X, D, Y, C, ~
 *
 *   Action:
 *   a, i, s, A, I, S, o, O
 *   zz, z., z<CR>, zt, zb, z-
 *   J
 *   u, Ctrl-r
 *   m<character>
 *   r<character>
 *
 *   Modes:
 *   ESC - leave insert mode, visual mode, and clear input state.
 *   Ctrl-[, Ctrl-c - same as ESC.
 *
 * Registers: unamed, -, a-z, A-Z, 0-9
 *   (Does not respect the special case for number registers when delete
 *    operator is made with these commands: %, (, ),  , /, ?, n, N, {, } )
 *   TODO: Implement the remaining registers.
 * Marks: a-z, A-Z, and 0-9
 *   TODO: Implement the remaining special marks. They have more complex
 *       behavior.
 *
 * Code structure:
 *  1. Default keymap
 *  2. Variable declarations and short basic helpers
 *  3. Instance (External API) implementation
 *  4. Internal state tracking objects (input state, counter) implementation
 *     and instanstiation
 *  5. Key handler (the main command dispatcher) implementation
 *  6. Motion, operator, and action implementations
 *  7. Helper functions for the key handler, motions, operators, and actions
 *  8. Set up Vim to work as a keymap for CodeMirror.
 */
(function(){"use strict";var e=[{keys:["Left"],type:"keyToKey",toKeys:["h"]},{keys:["Right"],type:"keyToKey",toKeys:["l"]},{keys:["Up"],type:"keyToKey",toKeys:["k"]},{keys:["Down"],type:"keyToKey",toKeys:["j"]},{keys:["Space"],type:"keyToKey",toKeys:["l"]},{keys:["Backspace"],type:"keyToKey",toKeys:["h"]},{keys:["Ctrl-Space"],type:"keyToKey",toKeys:["W"]},{keys:["Ctrl-Backspace"],type:"keyToKey",toKeys:["B"]},{keys:["Shift-Space"],type:"keyToKey",toKeys:["w"]},{keys:["Shift-Backspace"],type:"keyToKey",toKeys:["b"]},{keys:["Ctrl-n"],type:"keyToKey",toKeys:["j"]},{keys:["Ctrl-p"],type:"keyToKey",toKeys:["k"]},{keys:["Ctrl-["],type:"keyToKey",toKeys:["Esc"]},{keys:["Ctrl-c"],type:"keyToKey",toKeys:["Esc"]},{keys:["s"],type:"keyToKey",toKeys:["c","l"]},{keys:["S"],type:"keyToKey",toKeys:["c","c"]},{keys:["Home"],type:"keyToKey",toKeys:["0"]},{keys:["End"],type:"keyToKey",toKeys:["$"]},{keys:["PageUp"],type:"keyToKey",toKeys:["Ctrl-b"]},{keys:["PageDown"],type:"keyToKey",toKeys:["Ctrl-f"]},{keys:["H"],type:"motion",motion:"moveToTopLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["M"],type:"motion",motion:"moveToMiddleLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["L"],type:"motion",motion:"moveToBottomLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["h"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!1}},{keys:["l"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["j"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,linewise:!0}},{keys:["k"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,linewise:!0}},{keys:["g","j"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!0}},{keys:["g","k"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!1}},{keys:["w"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1}},{keys:["W"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1,bigWord:!0}},{keys:["e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,inclusive:!0}},{keys:["E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["b"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1}},{keys:["B"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1,bigWord:!0}},{keys:["g","e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,inclusive:!0}},{keys:["g","E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["{"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!1,toJumplist:!0}},{keys:["}"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!0,toJumplist:!0}},{keys:["Ctrl-f"],type:"motion",motion:"moveByPage",motionArgs:{forward:!0}},{keys:["Ctrl-b"],type:"motion",motion:"moveByPage",motionArgs:{forward:!1}},{keys:["Ctrl-d"],type:"motion",motion:"moveByScroll",motionArgs:{forward:!0,explicitRepeat:!0}},{keys:["Ctrl-u"],type:"motion",motion:"moveByScroll",motionArgs:{forward:!1,explicitRepeat:!0}},{keys:["g","g"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:["G"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!0,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:["0"],type:"motion",motion:"moveToStartOfLine"},{keys:["^"],type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["+"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0}},{keys:["-"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,toFirstChar:!0}},{keys:["_"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0,repeatOffset:-1}},{keys:["$"],type:"motion",motion:"moveToEol",motionArgs:{inclusive:!0}},{keys:["%"],type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:!0,toJumplist:!0}},{keys:["f","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["F","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!1}},{keys:["t","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["T","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!1}},{keys:[";"],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!0}},{keys:[","],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!1}},{keys:["'","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:["`","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:["]","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!0}},{keys:["[","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!1}},{keys:["]","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!0,linewise:!0}},{keys:["[","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!1,linewise:!0}},{keys:["]","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:!0,toJumplist:!0}},{keys:["[","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:!1,toJumplist:!0}},{keys:["|"],type:"motion",motion:"moveToColumn",motionArgs:{}},{keys:["d"],type:"operator",operator:"delete"},{keys:["y"],type:"operator",operator:"yank"},{keys:["c"],type:"operator",operator:"change",operatorArgs:{enterInsertMode:!0}},{keys:[">"],type:"operator",operator:"indent",operatorArgs:{indentRight:!0}},{keys:["<"],type:"operator",operator:"indent",operatorArgs:{indentRight:!1}},{keys:["g","~"],type:"operator",operator:"swapcase"},{keys:["n"],type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:!0}},{keys:["N"],type:"motion",motion:"findNext",motionArgs:{forward:!1,toJumplist:!0}},{keys:["x"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!0},operatorMotionArgs:{visualLine:!1}},{keys:["X"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!1},operatorMotionArgs:{visualLine:!0}},{keys:["D"],type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["Y"],type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["C"],type:"operatorMotion",operator:"change",operatorArgs:{enterInsertMode:!0},motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["~"],type:"operatorMotion",operator:"swapcase",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["Ctrl-i"],type:"action",action:"jumpListWalk",actionArgs:{forward:!0}},{keys:["Ctrl-o"],type:"action",action:"jumpListWalk",actionArgs:{forward:!1}},{keys:["a"],type:"action",action:"enterInsertMode",actionArgs:{insertAt:"charAfter"}},{keys:["A"],type:"action",action:"enterInsertMode",actionArgs:{insertAt:"eol"}},{keys:["i"],type:"action",action:"enterInsertMode"},{keys:["I"],type:"action",action:"enterInsertMode",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["o"],type:"action",action:"newLineAndEnterInsertMode",actionArgs:{after:!0}},{keys:["O"],type:"action",action:"newLineAndEnterInsertMode",actionArgs:{after:!1}},{keys:["v"],type:"action",action:"toggleVisualMode"},{keys:["V"],type:"action",action:"toggleVisualMode",actionArgs:{linewise:!0}},{keys:["J"],type:"action",action:"joinLines"},{keys:["p"],type:"action",action:"paste",actionArgs:{after:!0}},{keys:["P"],type:"action",action:"paste",actionArgs:{after:!1}},{keys:["r","character"],type:"action",action:"replace"},{keys:["R"],type:"action",action:"enterReplaceMode"},{keys:["u"],type:"action",action:"undo"},{keys:["Ctrl-r"],type:"action",action:"redo"},{keys:["m","character"],type:"action",action:"setMark"},{keys:['"',"character"],type:"action",action:"setRegister"},{keys:["z","z"],type:"action",action:"scrollToCursor",actionArgs:{position:"center"}},{keys:["z","."],type:"action",action:"scrollToCursor",actionArgs:{position:"center"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","t"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"}},{keys:["z","Enter"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","-"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"}},{keys:["z","b"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["."],type:"action",action:"repeatLastEdit"},{keys:["Ctrl-a"],type:"action",action:"incrementNumberToken",actionArgs:{increase:!0,backtrack:!1}},{keys:["Ctrl-x"],type:"action",action:"incrementNumberToken",actionArgs:{increase:!1,backtrack:!1}},{keys:["a","character"],type:"motion",motion:"textObjectManipulation"},{keys:["i","character"],type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:!0}},{keys:["/"],type:"search",searchArgs:{forward:!0,querySrc:"prompt",toJumplist:!0}},{keys:["?"],type:"search",searchArgs:{forward:!1,querySrc:"prompt",toJumplist:!0}},{keys:["*"],type:"search",searchArgs:{forward:!0,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:["#"],type:"search",searchArgs:{forward:!1,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:[":"],type:"ex"}],t=function(){function a(e,t){var n=[];for(var r=e;r<e+t;r++)n.push(String.fromCharCode(r));return n}function g(e){return r.test(e)}function y(e,t){return t>=e.firstLine()&&t<=e.lastLine()}function b(e){return/^[a-z]$/.test(e)}function w(e){return"()[]{}".indexOf(e)!=-1}function E(e){return i.test(e)}function S(e){return/^[A-Z]$/.test(e)}function x(e){return/^[\w]$/.test(e)}function T(e){return s.test(e)}function N(e){return/^\s*$/.test(e)}function C(e,t,n){return e>=t&&e<=n}function k(e,t){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1}function O(){return A||(A={searchQuery:null,searchIsReversed:!1,jumpList:L,lastChararacterSearch:{increment:0,forward:!0,selectedCharacter:""},registerController:new H({})}),A}function M(e){return e.vimState||(e.vimState={inputState:new D,lastHPos:-1,lastHSPos:-1,lastMotion:null,marks:{},visualMode:!1,visualLine:!1}),e.vimState}function D(){this.prefixRepeat=[],this.motionRepeat=[],this.operator=null,this.operatorArgs=null,this.motion=null,this.motionArgs=null,this.keyBuffer=[],this.registerName=null}function P(e,t){this.clear(),e&&this.set(e,t)}function H(e){this.registers=e,this.unamedRegister=e['"']=new P}function R(e,t,n){var r=Math.min(Math.max(e.firstLine(),t.line),e.lastLine()),i=Z(e,r)-1;i=n?i+1:i;var s=Math.min(Math.max(0,t.ch),i);return{line:r,ch:s}}function U(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function z(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function W(e,t,n){return{line:e.line+t,ch:e.ch+n}}function X(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function V(e,t){for(var n=0;n<e.length;n++)if(e[n]!=t[n]&&t[n]!="character")return!1;return!0}function $(e,t){for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0}function J(e,t,n){return function(){for(var r=0;r<n;r++)t(e)}}function K(e){return{line:e.line,ch:e.ch}}function Q(e,t){return e.ch==t.ch&&e.line==t.line}function G(e,t){return e.line<t.line?!0:e.line==t.line&&e.ch<t.ch?!0:!1}function Y(e,t,n){var r=G(e,t),i=G(t,n);return r&&i}function Z(e,t){return e.getLine(t).length}function et(e){return e.split("").reverse().join("")}function tt(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function nt(e){return e.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function rt(e,t){t.visualMode=!1,t.visualLine=!1;var n=e.getCursor("anchor"),r=e.getCursor("head");Q(n,r)||e.setCursor(R(e,r))}function it(e,t,n){var r=e.getRange(t,n),i=r.split("\n");i.length>1&&N(i.pop())&&(n.line--,n.ch=Z(e,n.line))}function st(e,t,n){t.ch=0,n.ch=0,n.line++}function ot(e){if(!e)return 0;var t=e.search(/\S/);return t==-1?e.length:t}function ut(e,t,n,r,i){var s=e.getCursor(),o=e.getLine(s.line),u=s.ch,a=o.substring(u),f;i?f=a.search(/\w/):f=a.search(/\S/);if(f==-1)return null;u+=f,a=o.substring(u);var l=o.substring(0,u),c;r?c=/^\S+/:/\w/.test(o.charAt(u))?c=/^\w+/:c=/^[^\w\s]+/;var h=c.exec(a),p=u,d=u+h[0].length,v=et(l),m=c.exec(v);m&&(p-=m[0].length);if(t){var g=o.substring(d),y=g.match(/^\s*/)[0].length;if(y>0)d+=y;else{var b=v.length-p,w=v.substring(b),E=w.match(/^\s*/)[0].length;p-=E}}return{start:{line:s.line,ch:p},end:{line:s.line,ch:d}}}function at(e,t,n){Q(t,n)||O().jumpList.add(e,t,n)}function ft(e,t){var n=O();n.lastChararacterSearch.increment=e,n.lastChararacterSearch.forward=t.forward,n.lastChararacterSearch.selectedCharacter=t.selectedCharacter}function ht(e,t,n,r){var i=e.getCursor(),s=n?1:-1,o=n?e.lineCount():-1,u=i.ch,a=i.line,f=e.getLine(a),l={lineText:f,nextCh:f.charAt(u),lastCh:null,index:u,symb:r,reverseSymb:(n?{")":"(","}":"{"}:{"(":")","{":"}"})[r],forward:n,depth:0,curMoveThrough:!1},c=lt[r];if(!c)return i;var h=ct[c].init,p=ct[c].isComplete;h&&h(l);while(a!==o&&t){l.index+=s,l.nextCh=l.lineText.charAt(l.index);if(!l.nextCh){a+=s,l.lineText=e.getLine(a)||"";if(s>0)l.index=0;else{var d=l.lineText.length;l.index=d>0?d-1:0}l.nextCh=l.lineText.charAt(l.index)}p(l)&&(i.line=a,i.ch=l.index,t--)}return l.nextCh||l.curMoveThrough?{line:a,ch:l.index}:i}function pt(e,t,n,r){var i=t.line,s=t.ch,a=e.getLine(i),f=n?1:-1,l=r?u:o;for(;;){var c=f>0?a.length:-1,h=c,p=c;while(s!=c){var d=!1;for(var v=0;v<l.length&&!d;++v)if(l[v].test(a.charAt(s))){h=s;while(s!=c&&l[v].test(a.charAt(s)))s+=f;p=s,d=h!=p;if(h==t.ch&&i==t.line&&p==h+f)continue;return{from:Math.min(h,p+1),to:Math.max(h,p),line:i}}d||(s+=f)}i+=f;if(!y(e,i))return null;a=e.getLine(i),s=f>0?0:a.length}throw"The impossible happened."}function dt(e,t,n,r,i){var s=e.getCursor();for(var o=0;o<t;o++){var u=s.ch,a=s.line,f,l=!1;while(!l){f=pt(e,s,n,i),l=!0;if(!f)return n?{line:s.line,ch:Z(e,s.line)}:{line:s.line,ch:0};s.line=f.line,n&&r?s.ch=f.to-1:n&&!r?C(s.ch,f.from,f.to)&&f.line==a?(l=!1,s.ch=f.to-1):s.ch=f.from:!n&&r?C(s.ch,f.from,f.to)&&f.line==a?(l=!1,s.ch=f.from):s.ch=f.to:!n&&!r&&(s.ch=f.from)}}return s}function vt(e,t,n,r){var i=e.getCursor(),s=i.ch,o;for(var u=0;u<t;u++){var a=e.getLine(i.line);o=yt(s,a,r,n,!0);if(o==-1)return null;s=o}return{line:e.getCursor().line,ch:o}}function mt(e,t){var n=e.getCursor().line;return R(e,{line:n,ch:t-1})}function gt(e,t,n,r){if(!k(n,v))return;t.marks[n]&&t.marks[n].clear(),t.marks[n]=e.setBookmark(r)}function yt(e,t,n,r,i){var s;return r?(s=t.indexOf(n,e+1),s!=-1&&!i&&(s-=1)):(s=t.lastIndexOf(n,e-1),s!=-1&&!i&&(s+=1)),s}function bt(e,t,n){var r=t.line;n=n?n:e.getLine(r).charAt(t.ch);var i={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{"}[n];if(!i)return t;var s={"(":1,"{":1,"[":1}[n]||-1,o=s===1?e.lineCount():-1,u=1,a=n,f=t.ch,l=e.getLine(r);while(r!==o&&u>0){f+=s,a=l.charAt(f);if(!a){r+=s,l=e.getLine(r)||"";if(s>0)f=0;else{var c=l.length;f=c>0?c-1:0}a=l.charAt(f)}a===n?u++:a===i&&u--}return a?{line:r,ch:f}:t}function wt(e,t,n){var r=e.getCursor(),i=bt(e,r,t),s=bt(e,i);return s.ch+=n?1:0,i.ch+=n?0:1,{start:s,end:i}}function Et(e,t,n){for(var r=n?n:e.length;r>=0;--r)if(t.test(e.charAt(r)))return r;return-1}function St(e,t,n){var r=e.getCursor(),i=e.getLine(r.line),s=i.split(""),o,u,a,f,l=s.indexOf(t);r.ch<l?r.ch=l:l<r.ch&&s[r.ch]==t&&(u=r.ch,--r.ch);if(s[r.ch]==t&&!u)o=r.ch+1;else for(a=r.ch;a>-1&&!o;a--)s[a]==t&&(o=a+1);if(o&&!u)for(a=o,f=s.length;a<f&&!u;a++)s[a]==t&&(u=a);return!o||!u?{start:r,end:r}:(n&&(--o,++u),{start:{line:r.line,ch:o},end:{line:r.line,ch:u}})}function xt(){}function Tt(e){var t=M(e);return t.searchState_||(t.searchState_=new xt)}function Nt(e,t,n,r,i){e.openDialog?e.openDialog(t,r,{bottom:!0,value:i.value,onKeyDown:i.onKeyDown,onKeyUp:i.onKeyUp}):r(prompt(n,""))}function Ct(e){var t=!1,n=[];for(var r=0;r<e.length;r++){var i=e.charAt(r);!t&&i=="/"&&n.push(r),t=i=="\\"}return n}function kt(e,t,n,r){if(t instanceof RegExp)return t;var i=Ct(t),s,o;if(!i.length)s=t;else{s=t.substring(0,i[0]);var u=t.substring(i[0]);o=u.indexOf("i")!=-1}if(!s)return null;r&&(n=/^[^A-Z]*$/.test(s));var a=new RegExp(s,n||o?"i":undefined);return a}function Lt(e,t){e.openConfirm?e.openConfirm('<span style="color: red">'+t+'</span> <button type="button">OK</button>',function(){},{bottom:!0}):alert(t)}function At(e,t){var n="";return e&&(n+='<span style="font-family: monospace">'+e+"</span>"),n+='<input type="text"/> <span style="color: #888">',t&&(n+='<span style="color: #888">',n+=t,n+="</span>"),n}function Mt(e,t){var n=(t.prefix||"")+" "+(t.desc||""),r=At(t.prefix,t.desc);Nt(e,r,n,t.onClose,t)}function _t(e,t){if(e instanceof RegExp&&t instanceof RegExp){var n=["global","multiline","ignoreCase","source"];for(var r=0;r<n.length;r++){var i=n[r];if(e[i]!==t[i])return!1}return!0}return!1}function Dt(e,t,n,r){if(!t)return;var i=Tt(e),s=kt(e,t,!!n,!!r);if(!s)return;return Ht(e,s),_t(s,i.getQuery())?s:(i.setQuery(s),s)}function Pt(e){if(e.source.charAt(0)=="^")var t=!0;return{token:function(n){if(t&&!n.sol()){n.skipToEnd();return}var r=n.match(e,!1);if(r){if(r[0].length==0){n.next();return}if(!n.sol()){n.backUp(1);if(!e.exec(n.next()+r[0]))return n.next(),null}return n.match(e),"searching"}while(!n.eol()){n.next();if(n.match(e,!1))break}},query:e}}function Ht(e,t){var n=Tt(e).getOverlay();if(!n||t!=n.query)n&&e.removeOverlay(n),n=Pt(t),e.addOverlay(n),Tt(e).setOverlay(n)}function Bt(e,t,n,r){return r===undefined&&(r=1),e.operation(function(){var i=e.getCursor();t||(i.ch+=1);var s=e.getSearchCursor(n,i);for(var o=0;o<r;o++)if(!s.find(t)){s=e.getSearchCursor(n,t?{line:e.lastLine()}:{line:e.firstLine(),ch:0});if(!s.find(t))return}return s.from()})}function jt(e){e.removeOverlay(Tt(e).getOverlay()),Tt(e).setOverlay(null)}function Ft(e,t,n){return typeof e!="number"&&(e=e.line),t instanceof Array?k(e,t):n?e>=t&&e<=n:e==t}function It(e){var t=e.getScrollInfo(),n=6,r=10,i=e.coordsChar({left:0,top:n},"local"),s=t.clientHeight-r,o=e.coordsChar({left:0,top:s},"local");return{top:i.line,bottom:o.line}}function Rt(e){var t=0,n=[];while(t<e.length){if(e.charAt(t)!="<"){n.push(e.charAt(t)),t++;continue}var r=++t;while(e.charAt(t++)!=">");var i=e.substring(r,t-1),s="",o=/^C-(.+)$/.exec(i);o&&(s="Ctrl-",i=o[1]);var u;switch(i){case"BS":u="Backspace";break;case"CR":u="Enter";break;case"Del":u="Delete";break;default:u=i}n.push(s+u)}return n}function Wt(){function e(e,t,r){S(t)&&(r=="Shift"?r=null:t=t.toLowerCase()),r&&(t=r+"-"+t),n.handleKey(e,t)}function t(t,n){return function(r){e(r,t,n)}}function s(e,n){for(var r=0;r<e.length;r++){var s=e[r];!n&&k(s,p)&&(s="'"+s+"'"),n?i[n+"-"+s]=t(e[r],n):i[s]=t(e[r])}}var r=["Shift","Ctrl"],i={nofallthrough:!0,style:"fat-cursor"};return s(f),s(f,"Shift"),s(f,"Ctrl"),s(p),s(p,"Ctrl"),s(c),s(c,"Ctrl"),s(d),s(d,"Ctrl"),i}function Xt(e){e.setCursor(e.getCursor().line,e.getCursor().ch-1,!0),e.setOption("keyMap","vim")}function Vt(e){e.toggleOverwrite(),e.setCursor(e.getCursor().line,e.getCursor().ch-1,!0),e.setOption("keyMap","vim")}var r=/[A-Za-z]/,i=/[\d]/,s=/\s/,o=[/\w/,/[^\w\s]/],u=[/\S/],f=a(65,26),l=a(97,26),c=a(48,10),h="~`!@#$%^&*()_-+=[{}]\\|/?.,<>:;\"'",p=h.split(""),d=["Left","Right","Up","Down","Space","Backspace","Esc","Home","End","PageUp","PageDown","Enter"],v=f.concat(l).concat(c).concat(["<",">"]),m=f.concat(l).concat(c).concat('-"'.split("")),L=function(){function s(s,o,u){function l(n){var r=++t%e,o=i[r];o&&o.clear(),i[r]=s.setBookmark(n)}var a=t%e,f=i[a];(!f||!Q(f.find(),o))&&l(o),l(u),n=t,r=t-e+1,r<0&&(r=0)}function o(s){return t+=s,t>n?t=n:t<r&&(t=r),i[(e+t)%e]}var e=100,t=-1,n=0,r=0,i=new Array(e);return{cachedCursor:undefined,add:s,move:o}}(),A,_={buildKeyMap:function(){},getRegisterController:function(){return O().registerController},clearVimGlobalState_:function(){A=null},map:function(e,t){zt.map(e,t)},defineEx:function(e,t,n){if(e.indexOf(t)!==0)throw new Error('(Vim.defineEx) "'+t+'" is not a prefix of "'+e+'", command not registered');Ut[e]=n,zt.commandMap_[t]={name:e,shortName:t,type:"api"}},maybeInitState:function(e){M(e)},handleKey:function(t,n){var r,i=M(t);if(n=="Esc"){i.inputState=new D,i.visualMode&&rt(t,i);return}i.visualMode&&Q(t.getCursor("head"),t.getCursor("anchor"))&&rt(t,i),!i.visualMode&&!Q(t.getCursor("head"),t.getCursor("anchor"))&&(i.visualMode=!0,i.visualLine=!1);if(n!="0"||n=="0"&&i.inputState.getRepeat()===0)r=B.matchCommand(n,e,i);if(!r){E(n)&&i.inputState.pushRepeatDigit(n);return}if(r.type=="keyToKey")for(var s=0;s<r.toKeys.length;s++)this.handleKey(t,r.toKeys[s]);else B.processCommand(t,i,r)}};D.prototype.pushRepeatDigit=function(e){this.operator?this.motionRepeat=this.motionRepeat.concat(e):this.prefixRepeat=this.prefixRepeat.concat(e)},D.prototype.getRepeat=function(){var e=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0)e=1,this.prefixRepeat.length>0&&(e*=parseInt(this.prefixRepeat.join(""),10)),this.motionRepeat.length>0&&(e*=parseInt(this.motionRepeat.join(""),10));return e},P.prototype={set:function(e,t){this.text=e,this.linewise=!!t},append:function(e,t){t||this.linewise?(this.text+="\n"+e,this.linewise=!0):this.text+=e},clear:function(){this.text="",this.linewise=!1},toString:function(){return this.text}},H.prototype={pushText:function(e,t,n,r){var i=this.isValidRegister(e)?this.getRegister(e):null;if(!i){switch(t){case"yank":this.registers[0]=new P(n,r);break;case"delete":case"change":n.indexOf("\n")==-1?this.registers["-"]=new P(n,r):(this.shiftNumericRegisters_(),this.registers[1]=new P(n,r))}this.unamedRegister.set(n,r);return}var s=S(e);s?(i.append(n,r),this.unamedRegister.append(n,r)):(i.set(n,r),this.unamedRegister.set(n,r))},getRegister:function(e){return this.isValidRegister(e)?(e=e.toLowerCase(),this.registers[e]||(this.registers[e]=new P),this.registers[e]):this.unamedRegister},isValidRegister:function(e){return e&&k(e,m)},shiftNumericRegisters_:function(){for(var e=9;e>=2;e--)this.registers[e]=this.getRegister(""+(e-1))}};var B={matchCommand:function(e,t,n){var r=n.inputState,i=r.keyBuffer.concat(e);for(var s=0;s<t.length;s++){var o=t[s];if(V(i,o.keys)){if(i.length<o.keys.length)return r.keyBuffer.push(e),null;if(r.operator&&o.type=="action")continue;if(o.keys[i.length-1]=="character"){r.selectedCharacter=i[i.length-1];if(r.selectedCharacter.length>1)switch(r.selectedCharacter){case"Enter":r.selectedCharacter="\n";break;case"Space":r.selectedCharacter=" ";break;default:continue}}return r.keyBuffer=[],o}}return r.keyBuffer=[],null},processCommand:function(e,t,n){t.inputState.repeatOverride=n.repeatOverride;switch(n.type){case"motion":this.processMotion(e,t,n);break;case"operator":this.processOperator(e,t,n);break;case"operatorMotion":this.processOperatorMotion(e,t,n);break;case"action":this.processAction(e,t,n);break;case"search":this.processSearch(e,t,n);break;case"ex":case"keyToEx":this.processEx(e,t,n);break;default:}},processMotion:function(e,t,n){t.inputState.motion=n.motion,t.inputState.motionArgs=z(n.motionArgs),this.evalInput(e,t)},processOperator:function(e,t,n){var r=t.inputState;if(r.operator){if(r.operator==n.operator){r.motion="expandToLine",r.motionArgs={linewise:!0},this.evalInput(e,t);return}t.inputState=new D}r.operator=n.operator,r.operatorArgs=z(n.operatorArgs),t.visualMode&&this.evalInput(e,t)},processOperatorMotion:function(e,t,n){var r=t.visualMode,i=z(n.operatorMotionArgs);i&&r&&i.visualLine&&(t.visualLine=!0),this.processOperator(e,t,n),r||this.processMotion(e,t,n)},processAction:function(e,t,n){var r=t.inputState,i=r.getRepeat(),s=!!i,o=z(n.actionArgs)||{};r.selectedCharacter&&(o.selectedCharacter=r.selectedCharacter),n.operator&&this.processOperator(e,t,n),n.motion&&this.processMotion(e,t,n),(n.motion||n.operator)&&this.evalInput(e,t),o.repeat=i||1,o.repeatIsExplicit=s,o.registerName=r.registerName,t.inputState=new D,t.lastMotion=null,I[n.action](e,o,t)},processSearch:function(e,t,n){function u(r,i,s){try{Dt(e,r,i,s)}catch(o){Lt(e,"Invalid regex: "+regexPart);return}B.processMotion(e,t,{type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:n.searchArgs.toJumplist}})}function a(t){e.scrollTo(o.left,o.top),u(t,!0,!0)}function f(t,n){var i;try{i=Dt(e,n,!0,!0)}catch(t){}i?e.scrollIntoView(Bt(e,!r,i),30):(jt(e),e.scrollTo(o.left,o.top))}function l(t,n,r){var i=CodeMirror.keyName(t);if(i=="Esc"||i=="Ctrl-C"||i=="Ctrl-[")Dt(e,s),jt(e),e.scrollTo(o.left,o.top),CodeMirror.e_stop(t),r(),e.focus()}if(!e.getSearchCursor)return;var r=n.searchArgs.forward;Tt(e).setReversed(!r);var i=r?"/":"?",s=Tt(e).getQuery(),o=e.getScrollInfo();switch(n.searchArgs.querySrc){case"prompt":Mt(e,{onClose:a,prefix:i,desc:Ot,onKeyUp:f,onKeyDown:l});break;case"wordUnderCursor":var c=ut(e,!1,!0,!1,!0),h=!0;c||(c=ut(e,!1,!0,!1,!1),h=!1);if(!c)return;var p=e.getLine(c.start.line).substring(c.start.ch,c.end.ch);h?p="\\b"+p+"\\b":p=nt(p),O().jumpList.cachedCursor=e.getCursor(),e.setCursor(c.start),u(p,!0,!1)}},processEx:function(e,t,n){function r(t){zt.processCommand(e,t)}function i(t,n,r){var i=CodeMirror.keyName(t);if(i=="Esc"||i=="Ctrl-C"||i=="Ctrl-[")CodeMirror.e_stop(t),r(),e.focus()}n.type=="keyToEx"?zt.processCommand(e,n.exArgs.input):t.visualMode?Mt(e,{onClose:r,prefix:":",value:"'<,'>",onKeyDown:i}):Mt(e,{onClose:r,prefix:":",onKeyDown:i})},evalInput:function(e,t){var n=t.inputState,r=n.motion,i=n.motionArgs||{},s=n.operator,o=n.operatorArgs||{},u=n.registerName,a=e.getCursor("head"),f=e.getCursor("anchor"),l=K(a),c=K(l),h,p;s&&this.recordLastEdit(e,t,n),n.repeatOverride!==undefined?p=n.repeatOverride:p=n.getRepeat();if(p>0&&i.explicitRepeat)i.repeatIsExplicit=!0;else if(i.noRepeat||!i.explicitRepeat&&p===0)p=1,i.repeatIsExplicit=!1;n.selectedCharacter&&(i.selectedCharacter=o.selectedCharacter=n.selectedCharacter),i.repeat=p,t.inputState=new D;if(r){var d=j[r](e,i,t);t.lastMotion=j[r];if(!d)return;if(i.toJumplist){var v=O().jumpList,m=v.cachedCursor;m?(at(e,m,d),delete v.cachedCursor):at(e,c,d)}d instanceof Array?(l=d[0],h=d[1]):h=d,h||(h={ch:l.ch,line:l.line}),t.visualMode?(G(f,a)&&(Q(f,h)||G(h,f))?f.ch+=1:G(a,f)&&(Q(f,h)||G(f,h))&&(f.ch-=1),a=h,t.visualLine&&(G(f,a)?(f.ch=0,a.ch=Z(e,a.line)):(a.ch=0,f.ch=Z(e,f.line))),e.setSelection(f,a),gt(e,t,"<",G(f,a)?f:a),gt(e,t,">",G(f,a)?a:f)):s||(h=R(e,h),e.setCursor(h.line,h.ch))}if(s){var g=!1;t.lastMotion=null,o.repeat=p,t.visualMode&&(l=f,h=a,i.inclusive=!0);if(G(h,l)){var y=l;l=h,h=y,g=!0}i.inclusive&&(!t.visualMode||!g)&&h.ch++;var b=i.linewise||t.visualMode&&t.visualLine;b?st(e,l,h):i.forward&&it(e,l,h),o.registerName=u,o.linewise=b,F[s](e,o,t,l,h,c),t.visualMode&&rt(e,t),o.enterInsertMode&&I.enterInsertMode(e)}},recordLastEdit:function(e,t,n){t.lastEdit=n}},j={moveToTopLine:function(e,t){var n=It(e).top+t.repeat-1;return{line:n,ch:ot(e.getLine(n))}},moveToMiddleLine:function(e){var t=It(e),n=Math.floor((t.top+t.bottom)*.5);return{line:n,ch:ot(e.getLine(n))}},moveToBottomLine:function(e,t){var n=It(e).bottom-t.repeat+1;return{line:n,ch:ot(e.getLine(n))}},expandToLine:function(e,t){var n=e.getCursor();return{line:n.line+t.repeat-1,ch:Infinity}},findNext:function(e,t,n){var r=Tt(e),i=r.getQuery();if(!i)return;var s=!t.forward;return s=r.isReversed()?!s:s,Ht(e,i),Bt(e,s,i,t.repeat)},goToMark:function(e,t,n){var r=n.marks[t.selectedCharacter];return r?r.find():null},jumpToMark:function(e,t,n){var r=e.getCursor();for(var i=0;i<t.repeat;i++){var s=r;for(var o in n.marks){if(!b(o))continue;var u=n.marks[o].find(),a=t.forward?G(u,s):G(s,u);if(a)continue;if(t.linewise&&u.line==s.line)continue;var f=Q(s,r),l=t.forward?Y(s,u,r):Y(r,u,s);if(f||l)r=u}}return t.linewise&&(r.ch=ot(e.getLine(r.line))),r},moveByCharacters:function(e,t){var n=e.getCursor(),r=t.repeat,i=t.forward?n.ch+r:n.ch-r;return{line:n.line,ch:i}},moveByLines:function(e,t,n){var r=e.getCursor(),i=r.ch;switch(n.lastMotion){case this.moveByLines:case this.moveByDisplayLines:case this.moveByScroll:case this.moveToColumn:case this.moveToEol:i=n.lastHPos;break;default:n.lastHPos=i}var s=t.repeat+(t.repeatOffset||0),o=t.forward?r.line+s:r.line-s;return o<e.firstLine()||o>e.lastLine()?null:(t.toFirstChar&&(i=ot(e.getLine(o)),n.lastHPos=i),n.lastHSPos=e.charCoords({line:o,ch:i},"div").left,{line:o,ch:i})},moveByDisplayLines:function(e,t,n){var r=e.getCursor();switch(n.lastMotion){case this.moveByDisplayLines:case this.moveByScroll:case this.moveByLines:case this.moveToColumn:case this.moveToEol:break;default:n.lastHSPos=e.charCoords(r,"div").left}var i=t.repeat,s=e.findPosV(r,t.forward?i:-i,"line",n.lastHSPos);if(s.hitSide)if(t.forward)var o=e.charCoords(s,"div"),u={top:o.top+8,left:n.lastHSPos},s=e.coordsChar(u,"div");else{var a=e.charCoords({line:e.firstLine(),ch:0},"div");a.left=n.lastHSPos,s=e.coordsChar(a,"div")}return n.lastHPos=s.ch,s},moveByPage:function(e,t){var n=e.getCursor(),r=t.repeat;e.moveV(t.forward?r:-r,"page");var i=e.getCursor();return e.setCursor(n),i},moveByParagraph:function(e,t){var n=e.getCursor().line,r=t.repeat,i=t.forward?1:-1;for(var s=0;s<r;s++){if(!t.forward&&n===e.firstLine()||t.forward&&n==e.lastLine())break;n+=i;while(n!==e.firstLine()&&n!=e.lastLine()&&e.getLine(n))n+=i}return{line:n,ch:0}},moveByScroll:function(e,t,n){var r=O(),i=e.getScrollInfo(),s=null,o=t.repeat;o||(o=i.clientHeight/(2*e.defaultTextHeight()));var u=e.charCoords(e.getCursor(),"local");t.repeat=o;var s=j.moveByDisplayLines(e,t,n);if(!s)return null;var a=e.charCoords(s,"local");return e.scrollTo(null,i.top+a.top-u.top),s},moveByWords:function(e,t){return dt(e,t.repeat,!!t.forward,!!t.wordEnd,!!t.bigWord)},moveTillCharacter:function(e,t){var n=t.repeat,r=vt(e,n,t.forward,t.selectedCharacter),i=t.forward?-1:1;return ft(i,t),r?(r.ch+=i,r):e.getCursor()},moveToCharacter:function(e,t){var n=t.repeat;return ft(0,t),vt(e,n,t.forward,t.selectedCharacter)||e.getCursor()},moveToSymbol:function(e,t){var n=t.repeat;return ht(e,n,t.forward,t.selectedCharacter)||e.getCursor()},moveToColumn:function(e,t,n){var r=t.repeat;return n.lastHPos=r-1,n.lastHSPos=e.charCoords(e.getCursor(),"div").left,mt(e,r)},moveToEol:function(e,t,n){var r=e.getCursor();n.lastHPos=Infinity;var i={line:r.line+t.repeat-1,ch:Infinity},s=e.clipPos(i);return s.ch--,n.lastHSPos=e.charCoords(s,"div").left,i},moveToFirstNonWhiteSpaceCharacter:function(e){var t=e.getCursor();return{line:t.line,ch:ot(e.getLine(t.line))}},moveToMatchedSymbol:function(e,t){var n=e.getCursor(),r=e.getLine(n.line).charAt(n.ch);return w(r)?bt(e,e.getCursor(),t.symbol):n},moveToStartOfLine:function(e){var t=e.getCursor();return{line:t.line,ch:0}},moveToLineOrEdgeOfDocument:function(e,t){var n=t.forward?e.lastLine():e.firstLine();return t.repeatIsExplicit&&(n=t.repeat-e.getOption("firstLineNumber")),{line:n,ch:ot(e.getLine(n))}},textObjectManipulation:function(e,t){var n=t.selectedCharacter,r=!t.textObjectInner;if(!q[n])return null;var i=q[n](e,r),s=i.start,o=i.end;return[s,o]},repeatLastCharacterSearch:function(e,t){var n=O().lastChararacterSearch,r=t.repeat,i=t.forward===n.forward,s=(n.increment?1:0)*(i?-1:1);e.moveH(-s,"char"),t.inclusive=i?!0:!1;var o=vt(e,r,i,n.selectedCharacter);return o?(o.ch+=s,o):(e.moveH(s,"char"),e.getCursor())}},F={change:function(e,t,n,r,i){O().registerController.pushText(t.registerName,"change",e.getRange(r,i),t.linewise),t.linewise?(r.ch=ot(e.getLine(r.line)),e.replaceRange("\n",r,i)):e.replaceRange("",r,i),e.setCursor(r)},"delete":function(e,t,n,r,i){O().registerController.pushText(t.registerName,"delete"
,e.getRange(r,i),t.linewise),e.replaceRange("",r,i),t.linewise?e.setCursor(j.moveToFirstNonWhiteSpaceCharacter(e)):e.setCursor(r)},indent:function(e,t,n,r,i){var s=r.line,o=i.line,u=n.visualMode?t.repeat:1;t.linewise&&o--;for(var a=s;a<=o;a++)for(var f=0;f<u;f++)e.indentLine(a,t.indentRight);e.setCursor(r),e.setCursor(j.moveToFirstNonWhiteSpaceCharacter(e))},swapcase:function(e,t,n,r,i,s){var o=e.getRange(r,i),u="";for(var a=0;a<o.length;a++){var f=o.charAt(a);u+=S(f)?f.toLowerCase():f.toUpperCase()}e.replaceRange(u,r,i),e.setCursor(s)},yank:function(e,t,n,r,i,s){O().registerController.pushText(t.registerName,"yank",e.getRange(r,i),t.linewise),e.setCursor(s)}},I={jumpListWalk:function(e,t,n){if(n.visualMode)return;var r=t.repeat,i=t.forward,s=O().jumpList,o=s.move(i?r:-r),u=o?o.find():e.getCursor();e.setCursor(u)},scrollToCursor:function(e,t){var n=e.getCursor().line,r=window.getComputedStyle(e.getScrollerElement()).getPropertyValue("height"),i=parseInt(r),s=e.charCoords({line:n,ch:0},"local").top,o=parseInt(i)/2;switch(t.position){case"center":s=s-i/2+10;break;case"bottom":s-=i;break;case"top":}e.scrollTo(null,s),e.scrollIntoView()},enterInsertMode:function(e,t){var n=t?t.insertAt:null;if(n=="eol"){var r=e.getCursor();r={line:r.line,ch:Z(e,r.line)},e.setCursor(r)}else n=="charAfter"&&e.setCursor(W(e.getCursor(),0,1));e.setOption("keyMap","vim-insert")},toggleVisualMode:function(e,t,n){var r=t.repeat,i=e.getCursor(),s;n.visualMode?(i=e.getCursor("anchor"),s=e.getCursor("head"),!n.visualLine&&t.linewise?(n.visualLine=!0,i.ch=G(i,s)?0:Z(e,i.line),s.ch=G(i,s)?Z(e,s.line):0,e.setSelection(i,s)):n.visualLine&&!t.linewise?n.visualLine=!1:rt(e,n)):(n.visualMode=!0,n.visualLine=!!t.linewise,n.visualLine?(i.ch=0,s=R(e,{line:i.line+r-1,ch:Z(e,i.line)},!0)):s=R(e,{line:i.line,ch:i.ch+r},!0),!t.repeatIsExplicit&&!n.visualLine?(e.setCursor(s),e.setSelection(s,i)):e.setSelection(i,s)),gt(e,n,"<",G(i,s)?i:s),gt(e,n,">",G(i,s)?s:i)},joinLines:function(e,t,n){var r,i;if(n.visualMode)r=e.getCursor("anchor"),i=e.getCursor("head"),i.ch=Z(e,i.line)-1;else{var s=Math.max(t.repeat,2);r=e.getCursor(),i=R(e,{line:r.line+s-1,ch:Infinity})}var o=0;e.operation(function(){for(var t=r.line;t<i.line;t++){o=Z(e,r.line);var n={line:r.line+1,ch:Z(e,r.line+1)},s=e.getRange(r,n);s=s.replace(/\n\s*/g," "),e.replaceRange(s,r,n)}var u={line:r.line,ch:o};e.setCursor(u)})},newLineAndEnterInsertMode:function(e,t){var n=e.getCursor();if(n.line===e.firstLine()&&!t.after)e.replaceRange("\n",{line:e.firstLine(),ch:0}),e.setCursor(e.firstLine(),0);else{n.line=t.after?n.line:n.line-1,n.ch=Z(e,n.line),e.setCursor(n);var r=CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent;r(e)}this.enterInsertMode(e)},paste:function(e,t,n){var r=e.getCursor(),i=O().registerController.getRegister(t.registerName);if(!i.text)return;for(var s="",o=0;o<t.repeat;o++)s+=i.text;var u=i.linewise;u?t.after?(s="\n"+s.slice(0,s.length-1),r.ch=Z(e,r.line)):r.ch=0:r.ch+=t.after?1:0,e.replaceRange(s,r);var a,f;u&&t.after?a={line:r.line+1,ch:ot(e.getLine(r.line+1))}:u&&!t.after?a={line:r.line,ch:ot(e.getLine(r.line))}:!u&&t.after?(f=e.indexFromPos(r),a=e.posFromIndex(f+s.length-1)):(f=e.indexFromPos(r),a=e.posFromIndex(f+s.length)),e.setCursor(a)},undo:function(e,t){J(e,CodeMirror.commands.undo,t.repeat)()},redo:function(e,t){J(e,CodeMirror.commands.redo,t.repeat)()},setRegister:function(e,t,n){n.inputState.registerName=t.selectedCharacter},setMark:function(e,t,n){var r=t.selectedCharacter;gt(e,n,r,e.getCursor())},replace:function(e,t,n){var r=t.selectedCharacter,i=e.getCursor(),s,o;if(n.visualMode)i=e.getCursor("start"),o=e.getCursor("end"),o=e.clipPos({line:o.line,ch:o.ch+1});else{var u=e.getLine(i.line);s=i.ch+t.repeat,s>u.length&&(s=u.length),o={line:i.line,ch:s}}if(r=="\n")n.visualMode||e.replaceRange("",i,o),(CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent)(e);else{var a=e.getRange(i,o);a=a.replace(/[^\n]/g,r),e.replaceRange(a,i,o),n.visualMode?(e.setCursor(i),rt(e,n)):e.setCursor(W(o,0,-1))}},enterReplaceMode:function(e,t){e.setOption("keyMap","vim-replace"),e.toggleOverwrite()},incrementNumberToken:function(e,t,n){var r=e.getCursor(),i=e.getLine(r.line),s=/-?\d+/g,o,u,a,f,l;while((o=s.exec(i))!==null){l=o[0],u=o.index,a=u+l.length;if(r.ch<a)break}if(!t.backtrack&&a<=r.ch)return;if(!l)return;var c=t.increase?1:-1,h=parseInt(l)+c*t.repeat,p={ch:u,line:r.line},d={ch:a,line:r.line};f=h.toString(),e.replaceRange(f,p,d),e.setCursor({line:r.line,ch:u+f.length-1})},repeatLastEdit:function(e,t,n){var r=n.lastEdit;if(r){t.repeat&&t.repeatIsExplicit&&(n.lastEdit.repeatOverride=t.repeat);var i=n.inputState;n.inputState=n.lastEdit,B.evalInput(e,n),n.inputState=i}}},q={w:function(e,t){return ut(e,t,!0,!1)},W:function(e,t){return ut(e,t,!0,!0)},"{":function(e,t){return wt(e,"}",t)},"(":function(e,t){return wt(e,")",t)},"[":function(e,t){return wt(e,"]",t)},"'":function(e,t){return St(e,"'",t)},'"':function(e,t){return St(e,'"',t)}},lt={"(":"bracket",")":"bracket","{":"bracket","}":"bracket","[":"section","]":"section","*":"comment","/":"comment",m:"method",M:"method","#":"preprocess"},ct={bracket:{isComplete:function(e){if(e.nextCh===e.symb){e.depth++;if(e.depth>=1)return!0}else e.nextCh===e.reverseSymb&&e.depth--;return!1}},section:{init:function(e){e.curMoveThrough=!0,e.symb=(e.forward?"]":"[")===e.symb?"{":"}"},isComplete:function(e){return e.index===0&&e.nextCh===e.symb}},comment:{isComplete:function(e){var t=e.lastCh==="*"&&e.nextCh==="/";return e.lastCh=e.nextCh,t}},method:{init:function(e){e.symb=e.symb==="m"?"{":"}",e.reverseSymb=e.symb==="{"?"}":"{"},isComplete:function(e){return e.nextCh===e.symb?!0:!1}},preprocess:{init:function(e){e.index=0},isComplete:function(e){if(e.nextCh==="#"){var t=e.lineText.match(/#(\w+)/)[1];if(t==="endif"){if(e.forward&&e.depth===0)return!0;e.depth++}else if(t==="if"){if(!e.forward&&e.depth===0)return!0;e.depth--}if(t==="else"&&e.depth===0)return!0}return!1}}};xt.prototype={getQuery:function(){return O().query},setQuery:function(e){O().query=e},getOverlay:function(){return this.searchOverlay},setOverlay:function(e){this.searchOverlay=e},isReversed:function(){return O().isReversed},setReversed:function(e){O().isReversed=e}};var Ot="(Javascript regexp)",qt=[{name:"map",type:"builtIn"},{name:"write",shortName:"w",type:"builtIn"},{name:"undo",shortName:"u",type:"builtIn"},{name:"redo",shortName:"red",type:"builtIn"},{name:"substitute",shortName:"s",type:"builtIn"},{name:"nohlsearch",shortName:"noh",type:"builtIn"},{name:"delmarks",shortName:"delm",type:"builtin"}];t.ExCommandDispatcher=function(){this.buildCommandMap_()},t.ExCommandDispatcher.prototype={processCommand:function(e,t){var r=new CodeMirror.StringStream(t),i={};i.input=t;try{this.parseInput_(e,r,i)}catch(s){Lt(e,s);return}var o;if(!i.commandName)i.line!==undefined&&(o="move");else{var u=this.matchCommand_(i.commandName);if(u){o=u.name,this.parseCommandArgs_(r,i,u);if(u.type=="exToKey"){for(var a=0;a<u.toKeys.length;a++)n.handleKey(e,u.toKeys[a]);return}if(u.type=="exToEx"){this.processCommand(e,u.toInput);return}}}if(!o){Lt(e,'Not an editor command ":'+t+'"');return}Ut[o](e,i)},parseInput_:function(e,t,n){t.eatWhile(":"),t.eat("%")?(n.line=e.firstLine(),n.lineEnd=e.lastLine()):(n.line=this.parseLineSpec_(e,t),n.line!==undefined&&t.eat(",")&&(n.lineEnd=this.parseLineSpec_(e,t)));var r=t.match(/^(\w+)/);return r?n.commandName=r[1]:n.commandName=t.match(/.*/)[0],n},parseLineSpec_:function(e,t){var n=t.match(/^(\d+)/);if(n)return parseInt(n[1],10)-1;switch(t.next()){case".":return e.getCursor().line;case"$":return e.lastLine();case"'":var r=M(e).marks[t.next()];if(r&&r.find())return r.find().line;throw"Mark not set";default:return t.backUp(1),e.getCursor().line}},parseCommandArgs_:function(e,t,n){if(e.eol())return;t.argString=e.match(/.*/)[0];var r=n.argDelimiter||/\s+/,i=tt(t.argString).split(r);i.length&&i[0]&&(t.args=i)},matchCommand_:function(e){for(var t=e.length;t>0;t--){var n=e.substring(0,t);if(this.commandMap_[n]){var r=this.commandMap_[n];if(r.name.indexOf(e)===0)return r}}return null},buildCommandMap_:function(){this.commandMap_={};for(var e=0;e<qt.length;e++){var t=qt[e],n=t.shortName||t.name;this.commandMap_[n]=t}},map:function(t,n){if(t!=":"&&t.charAt(0)==":"){var r=t.substring(1);n!=":"&&n.charAt(0)==":"?this.commandMap_[r]={name:r,type:"exToEx",toInput:n.substring(1)}:this.commandMap_[r]={name:r,type:"exToKey",toKeys:Rt(n)}}else n!=":"&&n.charAt(0)==":"?e.unshift({keys:Rt(t),type:"keyToEx",exArgs:{input:n.substring(1)}}):e.unshift({keys:Rt(t),type:"keyToKey",toKeys:Rt(n)})}};var Ut={map:function(e,t){var n=t.args;if(!n||n.length<2){e&&Lt(e,"Invalid mapping: "+t.input);return}zt.map(n[0],n[1],e)},move:function(e,t){B.processCommand(e,M(e),{type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0},repeatOverride:t.line+1})},substitute:function(e,t){function v(){for(var t=e.getSearchCursor(c,d);t.findNext()&&Ft(t.from(),h,p);){var n=e.getRange(t.from(),t.to()),r=n.replace(c,s);t.replace(r)}var i=M(e);i.visualMode&&rt(e,i)}var n=t.argString,r=Ct(n);if(r[0]!==0){Lt(e,"Substitutions should be of the form :s/pattern/replace/");return}var i=n.substring(r[0]+1,r[1]),s="",o,u;r[1]&&(s=n.substring(r[1]+1,r[2]));if(r[2]){var a=n.substring(r[2]+1).split(" ");o=a[0],u=parseInt(a[1])}o&&(i=i+"/"+o);if(i)try{Dt(e,i,!0,!0)}catch(f){Lt(e,"Invalid regex: "+i);return}var l=Tt(e),c=l.getQuery(),h=t.line||e.firstLine(),p=t.lineEnd||h;u&&(h=p,p=h+u-1);var d=R(e,{line:h,ch:0});e.operation(v)},redo:CodeMirror.commands.redo,undo:CodeMirror.commands.undo,write:function(e){CodeMirror.commands.save?CodeMirror.commands.save(e):e.save()},nohlsearch:function(e){jt(e)},delmarks:function(e,t){if(!t.argString||!t.argString.trim()){Lt(e,"Argument required");return}var n=M(e),r=new CodeMirror.StringStream(t.argString.trim());while(!r.eol()){r.eatSpace();var i=r.pos;if(!r.match(/[a-zA-Z]/,!1)){Lt(e,"Invalid argument: "+t.argString.substring(i));return}var s=r.next();if(r.match("-",!0)){if(!r.match(/[a-zA-Z]/,!1)){Lt(e,"Invalid argument: "+t.argString.substring(i));return}var o=s,u=r.next();if(!(b(o)&&b(u)||S(o)&&S(u))){Lt(e,"Invalid argument: "+o+"-");return}var a=o.charCodeAt(0),f=u.charCodeAt(0);if(a>=f){Lt(e,"Invalid argument: "+t.argString.substring(i));return}for(var l=0;l<=f-a;l++){var c=String.fromCharCode(a+l);delete n.marks[c]}}else delete n.marks[s]}}},zt=new t.ExCommandDispatcher;return CodeMirror.keyMap.vim=Wt(),CodeMirror.keyMap["vim-insert"]={Esc:Xt,"Ctrl-[":Xt,"Ctrl-C":Xt,"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(e){var t=CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent;t(e)},fallthrough:["default"]},CodeMirror.keyMap["vim-replace"]={Esc:Vt,"Ctrl-[":Vt,"Ctrl-C":Vt,Backspace:"goCharLeft",fallthrough:["default"]},_},n=t();CodeMirror.Vim=n})();