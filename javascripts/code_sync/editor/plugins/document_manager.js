(function(){CodeSync.plugins.DocumentManager=Backbone.View.extend({className:"codesync-document-manager",views:{},events:{"click .document-tab.selectable":"onDocumentTabSelection","click .document-tab.closable .close-anchor":"closeTab","click .document-tab.new-document":"createDocument","click .document-tab.save-document":"saveDocument","click .document-tab.open-document":"toggleAssetSelector","dblclick .document-tab.editable":"onDoubleClickTab","blur .document-tab.editable .contents":"onEditableTabBlur","keydown .document-tab.editable .contents":"onEditableTabKeyPress"},initialize:function(e){var t=this;return this.options=e!=null?e:{},_.extend(this,e),this.editor=e.editor,this.$el.append("<div class='document-tabs-container' />"),this.openDocuments=new CodeSync.Documents,this.openDocuments.on("add",this.renderTabs,this),this.openDocuments.on("remove",this.renderTabs,this),this.openDocuments.on("change:display",this.renderTabs,this),this.projectAssets=new CodeSync.ProjectAssets,this.state=new Backbone.Model({currentDocument:void 0}),this.state.on("change:currentDocument",this.highlightActiveDocumentTab,this),this.on("editor:hidden",function(){return t.$(".document-tab.hideable").hide()}),this.on("editor:visible",function(){return t.$(".document-tab.hideable").show(),t.toggleSaveButton()}),this.views.assetSelector=new CodeSync.AssetSelector({collection:this.projectAssets,documents:this.openDocuments,editor:this.editor}),this.views.assetSelector.on("asset:selected",this.onAssetSelection,this)},documentInTab:function(e){var t,n;e.is(".document-tab")||(e=e.parents(".document-tab").eq(0));if(t=e.data("document-cid"))return n=this.openDocuments.detect(function(e){return e.cid===t})},renderTabs:function(){var e,t,n=this;e=this.$(".document-tabs-container").empty(),t=JST["code_sync/editor/templates/document_manager_tab"],this.openDocuments.each(function(r,i){if(n.skipTabForDefault!==!0||i!==0)return e.append(t({doc:r,index:i}))}),this.allowNew!==!1&&e.append(t({display:"New",cls:"new-document"}));if(this.allowOpen!==!1)return e.append(t({display:"Open",cls:"open-document"}))},onAssetSelection:function(e){var t=this;return this.openDocuments.findOrCreateForPath(e,function(e){return t.openDocument(e)})},onEditableTabKeyPress:function(e){var t,n,r,i;i=this.$(e.target).closest(".document-tab"),t=i.children(".contents");if(e.keyCode===13||e.keyCode===27){e.preventDefault(),t.attr("contenteditable",!1);if(n=this.documentInTab(i))e.keyCode===13&&n.set("name",t.html()),e.keyCode===27&&(r=i.attr("data-original-value"))&&t.html(r);return this.editor.codeMirror.focus()}},onEditableTabBlur:function(e){var t,n,r,i;r=this.$(e.target).closest(".document-tab"),t=r.children(".contents"),console.log("On Editable Tab Blur",(i=this.documentInTab(r))!=null?i.cid:void 0);if(n=this.documentInTab(r))return n.set("name",t.html()),t.attr("contenteditable",!1)},onDoubleClickTab:function(e){var t,n;return n=this.$(e.target).closest(".document-tab"),t=n.children(".contents"),n.attr("data-original-value",t.html()),t.attr("contenteditable",!0)},onDocumentTabSelection:function(e){var t,n;return this.trigger("tab:click"),n=this.$(e.target).closest(".document-tab"),t=this.documentInTab(n),this.setCurrentDocument(t)},closeTab:function(e){var t,n,r;return r=this.$(e.target),t=this.documentInTab(r),n=this.openDocuments.indexOf(t),this.openDocuments.remove(t),this.setCurrentDocument(this.openDocuments.at(n-1)||this.openDocuments.at(0))},getCurrentDocument:function(){return this.currentDocument},openDocument:function(e,t){return t||(t=this.editor),this.openDocuments.add(e),this.setCurrentDocument(e,t)},setCurrentDocument:function(e,t){return this.currentDocument=e,t||(t=this.editor),t.loadDocument(this.currentDocument)},toggleSaveButton:function(){var e,t;return((e=this.currentDocument)!=null?(t=e.get("path"))!=null?t.length:void 0:void 0)>0?this.$(".save-document").show():this.$(".save-document").hide()},saveDocument:function(){return CodeSync.get("disableAssetSave")?this.editor.showStatusMessage({type:"error",message:"Saving is disabled in this demo."}):this.currentDocument.saveToDisk()},createDocument:function(){var e;return this.openDocuments.add({name:"untitled",display:"Untitled",mode:CodeSync.get("defaultFileType"),extension:CodeSync.Modes.guessExtensionFor(CodeSync.get("defaultFileType"))}),e=this.openDocuments.last(),this.openDocument(e)},toggleAssetSelector:function(){return this.views.assetSelector.toggle()},render:function(){return this.$el.append(this.views.assetSelector.render().el),this}}),CodeSync.plugins.DocumentManager.setup=function(e,t){var n,r=this;return t==null&&(t={}),t.editor=e,n=this.views.documentManager=new CodeSync.plugins.DocumentManager(t),_.extend(e.codeMirrorKeyBindings,{"Ctrl-T":function(){return n.toggleAssetSelector()},"Ctrl-S":function(){return n.getCurrentDocument().save()},"Ctrl-N":function(){return n.createDocument()}}),this.$el.append(n.render().el),n.on("tab:click",function(){if(r.visible===!1)return r.show()}),CodeSync.AssetEditor.prototype.loadDefaultDocument=function(){var t;return t=e.getDefaultDocument(),n.openDocument(t)}}}).call(this);